<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MistCall</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pinyon+Script&display=swap" rel="stylesheet">
    <style>
        /* --- CSS å˜é‡åˆå§‹åŒ– --- */
        :root {
            --page-bg: #f7f9fc;
            --msg-bg: #f8f9fa;
            --style-bg: #f8f9fa;
            --input-bg: #ffffff;
            
            /* æ°”æ³¡å®Œå…¨å˜é‡åŒ– */
            --bot-bubble-img: none;
            --bot-bubble-slice: 0;
            --bot-bubble-width: 0;
            --bot-bubble-padding: 10px;
            --bot-bubble-min-height: 40px;
            --bot-bubble-text-color: #333;
            --bot-bubble-border-style: solid;
            
            --user-bubble-img: none;
            --user-bubble-slice: 0;
            --user-bubble-width: 0;
            --user-bubble-padding: 10px;
            --user-bubble-min-height: 40px;
            --user-bubble-text-color: #fff;
            --user-bubble-border-style: solid;
            
            /* æ–°å¢é€æ˜UIå˜é‡ */
            --header-bg: rgba(255,255,255,0.8);
            --nav-bg: rgba(255,255,255,0.95);
            --card-bg: rgba(255,255,255,0.9);
            --ui-blur: 8px;
            --text-color: #1e293b;
            
            /* æ–°å¢æ²‰æµ¸å¼UIå˜é‡ */
            --ui-header-bg: rgba(255,255,255,0.8);
            --ui-nav-bg: rgba(255,255,255,0.95);
            --ui-card-bg: rgba(255,255,255,0.9);
            --ui-text-main: #1e293b;
            --ui-text-sub: #94a3b8;
            --ui-blur: 8px;
            --ui-icon-size: 24px;
            
            /* æ–°å¢æ°”æ³¡å˜é‡ï¼ˆæ–°å‘½åï¼‰ */
            --bot-min-h: 40px;
            --bot-text-color: #333;
            --user-min-h: 40px;
            --user-text-color: #fff;
            
            /* æ–°å¢åº•å›¾å˜é‡ */
            --page-bg-img: none;
        }

        /* åº”ç”¨èƒŒæ™¯å›¾ */
        #main-app { background: var(--page-bg-img) !important; background-size: cover; }
        #tab-msg { background: var(--msg-bg); background-size: cover; }
        #tab-style { background: var(--style-bg); background-size: cover; }
        .chat-footer { background: var(--input-bg) !important; background-size: cover; }

        /* æ™ºèƒ½ä½“æ°”æ³¡è¡¥ä¸æ ·å¼ - å®Œå…¨å˜é‡åŒ– */
        .bubble-bot {
            border-image-source: var(--bot-bubble-img);
            border-image-slice: var(--bot-bubble-slice);
            border-width: var(--bot-bubble-width);
            border-style: var(--bot-bubble-border-style);
            padding: var(--bot-bubble-padding) !important;
            min-height: var(--bot-min-h) !important;
            display: flex;
            align-items: center;
            box-sizing: border-box;
            background: none !important; /* æœ‰ä¸»é¢˜æ—¶å»æ‰é»˜è®¤åº•è‰² */
            color: var(--bot-text-color) !important;
            font-size: 0.95rem;
            line-height: 1.5;
            word-wrap: break-word;
            max-width: 70%;
            border-radius: 0; /* ç”±è¾¹æ¡†å›¾ç‰‡æä¾›åœ†è§’ */
            margin-left: 10px;
        }

        /* æˆ‘çš„æ°”æ³¡è¡¥ä¸æ ·å¼ - å®Œå…¨å˜é‡åŒ– */
        .bubble-user {
            border-image-source: var(--user-bubble-img);
            border-image-slice: var(--user-bubble-slice);
            border-width: var(--user-bubble-width);
            border-style: var(--user-bubble-border-style);
            padding: var(--user-bubble-padding) !important;
            min-height: var(--user-min-h) !important;
            display: flex;
            align-items: center;
            box-sizing: border-box;
            background: none !important;
            color: var(--user-text-color) !important;
            font-size: 0.95rem;
            line-height: 1.5;
            word-wrap: break-word;
            max-width: 70%;
            border-radius: 0; /* ç”±è¾¹æ¡†å›¾ç‰‡æä¾›åœ†è§’ */
            margin-right: 10px;
        }

        /* å¯¼èˆªæ å›¾æ ‡åŠ å¤§ï¼Œå¹¶æ‹‰è¿‘ä¸æ–‡å­—çš„è·ç¦» */
        .nav-item img { 
            width: 42px !important; /* ä»36pxæ”¾å¤§åˆ°42px */
            height: 42px !important; 
            object-fit: contain; 
            margin-bottom: -2px; /* è´Ÿè¾¹è·è®©æ–‡å­—è´´è¿‘å›¾æ ‡ */
            transition: all 0.3s ease; /* å¢åŠ å¹³æ»‘è¿‡æ¸¡ */
            -webkit-touch-callout: none; /* ç¦æ­¢é•¿æŒ‰å¼¹å‡ºä¸‹è½½èœå• */
        }

        /* å¯¼èˆªæ é¡¹ç›®å¸ƒå±€è°ƒæ•´ */
        .nav-item { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            color: var(--ui-text-sub) !important; 
            cursor: pointer; 
            font-size: 0.7rem; 
            gap: 0px; /* å½»åº•æ¶ˆé™¤é—´éš™ */
        }

        /* --- å…¨å±€é‡ç½® --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        input[type="text"], input[type="password"], textarea { border: 1px solid #ddd; }
        body, html { width: 100%; height: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; background-color: #f7f9fc; color: #333; margin: 0; padding: 0; }

        /* å…¨å±€ç¦æ­¢å›¾ç‰‡é•¿æŒ‰å¼¹å‡ºç³»ç»Ÿèœå• */
        img {
            -webkit-touch-callout: none !important; 
            -webkit-user-select: none !important;
            user-select: none !important;
            pointer-events: auto; /* ä¿è¯ç‚¹å‡»äº‹ä»¶ä¾ç„¶æœ‰æ•ˆ */
        }

        /* --- 1. å°é¢ --- */
        #cover-page {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999;
            background: linear-gradient(135deg, #ffffff 0%, #e3e6e8 40%, #8d99ae 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.6s ease;
        }
        .brand-title {
            font-family: 'Pinyon Script', cursive; font-size: 6rem;
            background: linear-gradient(to right, #ffffff 0%, #a3b5d3 25%, #b8a9c6 50%, #d3a3b5 75%, #ffffff 100%);
            background-size: 200% auto;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite;
            margin-bottom: 20px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
            line-height: 1.2;
        }
        @keyframes shine { 
            from { background-position: 200% center; }
            to { background-position: -200% center; }
        }
        .tap-hint { font-size: 0.75rem; letter-spacing: 3px; text-transform: uppercase; color: #555; opacity: 0.6; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { opacity: 0.3; } 50% { opacity: 0.8; } }

        /* --- ä¸»ç¨‹åº --- */
        #main-app { display: none; width: 100%; height: 100%; flex-direction: column; opacity: 0; transition: opacity 0.4s ease; }
        
        /* Header - å˜é€æ˜ */
        .header { 
            height: 50px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; 
            background: var(--ui-header-bg) !important; 
            backdrop-filter: blur(var(--ui-blur));
            border-bottom: 1px solid rgba(255,255,255,0.2); 
            z-index: 10; 
            flex-shrink: 0;
        }
        .header-title { font-weight: 600; font-size: 1.05rem; text-align: center; flex: 1; color: var(--ui-text-main) !important; }
        .header-icon { cursor: pointer; color: #2980b9; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }

        .content-area { flex: 1; overflow-y: auto; background: #f8f9fa; position: relative; overflow-x: hidden; }
        .tab-page { display: none; padding-bottom: 100px; height: 100%; }
        .tab-page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Bottom Nav - å˜é€æ˜ */
        .bottom-nav { 
            height: 60px; 
            background: var(--ui-nav-bg) !important; 
            backdrop-filter: blur(var(--ui-blur));
            border-top: 1px solid rgba(255,255,255,0.2); 
            display: flex; padding-bottom: env(safe-area-inset-bottom); flex-shrink: 0;
        }
        .nav-item.active { color: #334155; font-weight: 600; }

        /* --- Msg List Swipe Styles - å˜é€æ˜ --- */
        .msg-cell-wrapper { 
            position: relative; overflow: hidden; 
            background-color: #ffffff !important; /* åˆ—è¡¨å®¹å™¨ä¹Ÿè®¾ä¸ºç™½è‰²ï¼Œé˜²æ­¢æ»‘åŠ¨æ—¶çš„ç¼éš™é€å‡ºèƒŒæ™¯ */
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            height: 80px; 
        }
        .msg-cell-content {
            width: 100%; height: 100%; 
            background-color: #ffffff !important; /* é»˜è®¤ç™½è‰²ä¸é€æ˜ */
            background-image: var(--ui-card-bg) !important; /* å¦‚æœæœ‰çš®è‚¤ï¼Œåº”ç”¨çš®è‚¤èƒŒæ™¯ */
            background-size: cover;
            opacity: 1 !important; /* ç¡®ä¿ä¸é€æ˜ */
            backdrop-filter: blur(var(--ui-blur));
            display: flex; align-items: center; padding: 0 20px;
            position: absolute; top: 0; left: 0; z-index: 10; transition: transform 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
            cursor: pointer;
        }
        .msg-cell-actions {
            position: absolute; top: 0; right: 0; height: 100%; display: flex; z-index: 5;
        }
        .swipe-btn {
            width: 70px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #fff; font-size: 0.75rem; font-weight: bold; gap: 4px; cursor: pointer;
        }
        .btn-pin { background-color: #f39c12; }
        .btn-del { background-color: #e74c3c; }
        
        .cell-avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; background: #eee; border: 1px solid #eee; pointer-events: none; }
        .cell-content { pointer-events: none; flex: 1; }
        .cell-content h3 { font-size: 1rem; color: #333; margin-bottom: 4px; font-weight: 600; display: flex; justify-content: space-between; }
        .pin-icon { width: 14px; height: 14px; color: #f39c12; display: none; }
        .is-pinned .pin-icon { display: block; }
        .is-pinned { background: rgba(255, 252, 245, 0.9); } 
        .cell-content p { font-size: 0.85rem; color: #888; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 200px; }

        /* --- Page: Me --- */
        .settings-card { 
            background: var(--ui-card-bg) !important; 
            backdrop-filter: blur(var(--ui-blur));
            border-radius: 12px; 
            margin: 10px;
            padding: 0 20px; 
            margin-bottom: 15px; 
        }
        .card-header { padding: 20px 0 10px 0; font-size: 0.9rem; font-weight: bold; color: #2c3e50; border-bottom: 1px solid #eee; margin-bottom: 10px; }
        .field-row { padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .field-label { display: block; font-size: 0.75rem; color: #888; margin-bottom: 5px; }
        .input-group { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        /* ç»Ÿä¸€è¾“å…¥æ¡†å®½åº¦ */
        .field-input { 
            flex: 1; 
            border: none; 
            font-size: 0.95rem; 
            background: transparent; 
            padding: 8px 0; 
            color: #333; 
            outline: none;
            width: 100%;
            min-width: 0; /* é˜²æ­¢flexå¸ƒå±€æº¢å‡º */
        }
        .btn-mini { padding: 6px 12px; background: #eef2f5; color: #5d6d7e; font-size: 0.75rem; border-radius: 4px; border: 1px solid #dce1e6; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .btn-mini.success { background: #ebf9f1; color: #27ae60; border-color: #d1e7dd; }
        .model-list-pop { background: rgba(255,255,255,0.95); border: 1px solid #eee; border-radius: 6px; margin-top: 5px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease; backdrop-filter: blur(var(--ui-blur)); }
        .model-list-pop.show { max-height: 300px; overflow-y: auto; padding: 5px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .model-opt { padding: 8px 12px; font-size: 0.85rem; color: #666; cursor: pointer; border-bottom: 1px solid #fbfbfb; }
        .model-opt:hover { background: #f5f7fa; color: #2c3e50; }

        /* --- Agent Editor --- */
        #agent-editor {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff;
            z-index: 400; display: none; flex-direction: column; overflow-y: auto;
            transform: translateY(100%); transition: transform 0.3s ease;
        }
        #agent-editor.open { transform: translateY(0); }
        .editor-nav { height: 50px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-bottom: 1px solid #eee; background: #fff; position: sticky; top: 0; z-index: 20; }

        .visual-editor { position: relative; width: 100%; height: 260px; background: #f0f2f5; margin-bottom: 20px; }
        .bg-upload-zone {
            width: 100%; height: 200px; background: #e1e4e8; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .bg-upload-zone img, .bg-upload-zone video { width: 100%; height: 100%; object-fit: cover; object-position: center; }
        
        .avatar-upload-zone {
            width: 80px; height: 80px; border-radius: 50%; background: #fff;
            position: absolute; bottom: 10px; left: 20px;
            border: 3px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; z-index: 10;
        }
        .avatar-upload-zone img { width: 100%; height: 100%; object-fit: cover; object-position: center; }

        .editor-form { padding: 0 20px; padding-bottom: 50px; }
        .form-section { margin-bottom: 20px; position: relative; }
        .section-label { font-size: 0.85rem; font-weight: bold; color: #34495e; margin-bottom: 8px; border-left: 3px solid #34495e; padding-left: 8px; display: flex; justify-content: space-between; align-items: center; }
        .edit-input { width: 100%; padding: 12px; background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; font-size: 0.9rem; outline: none; }
        .textarea-wrapper { position: relative; }
        .edit-area { width: 100%; padding: 12px; padding-right: 30px; background: #f8f9fa; border: 1px solid #eee; border-radius: 8px; font-size: 0.9rem; height: 100px; resize: none; outline: none; }
        .expand-btn { 
            position: absolute; top: 8px; right: 8px; color: #64748b; cursor: pointer; z-index: 5;
            width: 24px; height: 24px; background: rgba(255,255,255,0.6); border-radius: 4px;
            display: flex; align-items: center; justify-content: center; border: 1px solid #e2e8f0;
        }

        #edit-gender { width: auto; flex: none; padding: 12px 20px; text-align: center; }
        .char-limit { text-align: right; font-size: 0.7rem; color: #999; margin-top: 2px; }

        /* Fullscreen Editor */
        #fullscreen-editor { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 500; display: none; flex-direction: column; }
        #fullscreen-editor.open { display: flex; animation: fadeIn 0.2s; }
        .fs-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: flex-end; }
        .fs-done { color: #2980b9; font-weight: bold; cursor: pointer; }
        .fs-input { flex: 1; padding: 20px; border: none; font-size: 1rem; line-height: 1.6; resize: none; outline: none; }

        /* --- Chat Room --- */
        #chat-room {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000;
            z-index: 300; display: none; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s;
        }
        #chat-room.open { transform: translateX(0); }
        
        .chat-bg-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; 
            background-size: cover !important; 
            background-position: center !important; 
            background-repeat: no-repeat;
        }
        
        .chat-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: rgba(0,0,0,0.4); pointer-events: none; }
        .chat-header-trans { height: 50px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; color: #fff; font-weight: bold; z-index: 10; background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent); }
        .chat-main { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; z-index: 10; padding-bottom: 20px; }
        
        .chat-row { display: flex; flex-direction: column; margin-bottom: 5px; }
        .chat-row-inner { display: flex; align-items: flex-start; }
        .chat-row.bot .chat-row-inner { justify-content: flex-start; }
        .chat-row.user .chat-row-inner { justify-content: flex-end; }
        .chat-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.3); }
        
        .msg-actions { display: flex; align-items: center; gap: 6px; margin-top: 6px; }
        .chat-row.bot .msg-actions { margin-left: 50px; justify-content: flex-start; }
        .chat-row.user .msg-actions { margin-right: 50px; justify-content: flex-end; }
        
        .action-btn { 
            font-size: 0.65rem; color: rgba(255,255,255,0.8); background: rgba(0,0,0,0.4); 
            padding: 2px 8px; border-radius: 8px; cursor: pointer; backdrop-filter: blur(4px); 
            transition: background 0.2s; border: 1px solid rgba(255,255,255,0.1);
        }
        .action-btn:hover { background: rgba(255,255,255,0.25); color: #fff; }

        /* èŠå¤©é¡µè¾“å…¥æ¡†èƒŒæ™¯å›¾è¡¥ä¸ */
        .chat-footer { 
            background-color: #ffffff !important; /* é»˜è®¤ç™½è‰²ï¼Œä¸è£…çš®è‚¤ä¹Ÿä¸ä¼šé€æ˜ */
            background-image: var(--input-bg) !important; /* æœ‰çš®è‚¤æ—¶è¦†ç›–å›¾ç‰‡ */
            background-size: 100% 100%;
            border-top: 1px solid #eee !important; /* æ²¡çš®è‚¤æ—¶åŠ ä¸€æ¡ç»†çº¿åŒºåˆ† */
            padding: 10px 15px; 
            display: flex; 
            align-items: center; 
            z-index: 10; 
            padding-bottom: max(10px, env(safe-area-inset-bottom)); 
            gap: 10px; 
            position: relative;
        }
        /* å†…éƒ¨è¾“å…¥æ¡†æ–‡å­—é¢œè‰²é€‚é… */
        #msg-in {
            background: rgba(0,0,0,0.05) !important; /* æµ…ç°è‰²èƒŒæ™¯ï¼Œæ›´åƒå¾®ä¿¡/QQ */
            color: #333 !important; /* é»˜è®¤é»‘å­— */
            flex: 1; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 20px; 
            font-size: 0.95rem; 
            height: 40px;
        }
        /* å¦‚æœå½“å‰æ˜¯é€æ˜çš®è‚¤æ¨¡å¼ï¼Œé€šè¿‡å˜é‡è‡ªåŠ¨è°ƒèŠ‚ */
        #msg-in::placeholder {
            color: #999 !important;
        }
        .icon-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #64748b; transition: all 0.2s; }
        .icon-btn:active { color: #334155; transform: scale(0.9); }
        .icon-btn.send-btn { color: #2563eb; }

        .normal-save-container { width: 100%; display: flex; justify-content: center; padding: 30px 0; }
        .btn-save {
            background: #2c3e50; color: #fff; padding: 12px 40px;
            border-radius: 30px; border: none; font-size: 0.95rem; font-weight: 600;
            box-shadow: 0 5px 15px rgba(44, 62, 80, 0.3); cursor: pointer;
            transition: background 0.3s;
        }

        /* --- More Panel (Drawer) --- */
        #more-panel {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 85%; 
            background: #fff; border-radius: 20px 20px 0 0; z-index: 50; 
            transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column; padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.4);
        }
        #more-panel.open { transform: translateY(0); }
        .more-header { padding: 15px; text-align: center; border-bottom: 1px solid #eee; position: relative; font-weight: bold; color: #334155; display: flex; align-items: center; justify-content: center;}
        .more-close { position: absolute; right: 15px; top: 15px; color: #94a3b8; cursor: pointer; }
        
        /* 4 icons per page (25% width), scrollable */
        .more-tabs { display: flex; border-bottom: 1px solid #eee; overflow-x: auto; scroll-snap-type: x mandatory; }
        .more-tab { 
            flex: 0 0 25%; /* Fixed width to show exactly 4 */
            text-align: center; padding: 12px 0; font-size: 0.9rem; color: #94a3b8; 
            cursor: pointer; border-bottom: 2px solid transparent; display: flex; 
            justify-content: center; gap: 5px; align-items: center; white-space: nowrap;
            scroll-snap-align: start;
        }
        .more-tab.active { color: #334155; font-weight: bold; border-bottom-color: #334155; }
        .more-tab i { width: 16px; height: 16px; }
        
        .more-content { flex: 1; overflow-y: auto; padding: 0; display: none; background: #f8f9fa; touch-action: pan-y; position: relative; }
        .more-content.active { display: block; }
        .more-inner-pad { padding: 20px; }
        
        .swipe-handle-bar {
            width: 100%; height: 30px; display: flex; justify-content: center; align-items: center;
            background: #fff; margin-top: auto; flex-shrink: 0; cursor: grab;
            border-top: 1px solid transparent; transition: border 0.3s;
        }
        .swipe-indicator {
            width: 60px; height: 5px; background: #cbd5e1; border-radius: 10px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #more-panel.open .swipe-indicator { width: 100px; background: #94a3b8; }
        .swipe-handle-bar:active .swipe-indicator { width: 85px; transform: scaleY(1.3); background: #64748b; }

        /* Slot UI */
        .slot-container { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .save-slot { 
            width: 100%; height: 60px; border: 2px solid #e2e8f0; border-radius: 12px; background: #fff;
            display: flex; flex-direction: row; align-items: center; justify-content: flex-start; padding: 0 20px;
            cursor: pointer; position: relative; overflow: hidden; transition: all 0.2s; gap: 15px;
        }
        .save-slot.active { border-color: #334155; background: #f1f5f9; }
        .save-slot i { color: #64748b; margin-bottom: 0; }
        .save-slot small { font-size: 1rem; color: #334155; font-weight: 500; }
        .slot-badge { position: absolute; top: 50%; right: 20px; transform: translateY(-50%); width: 8px; height: 8px; background: #ef4444; border-radius: 50%; opacity: 0; }
        .save-slot.has-data .slot-badge { opacity: 1; }

        /* --- Twitter Page --- */
        .file-input { display: none; }
        .twitter-container { background: #000; min-height: 100%; color: #e7e9ea; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding-bottom: 60px;}
        .tweet-card { border-bottom: 1px solid #2f3336; padding: 12px 16px; transition: background 0.2s; }
        .tweet-card:hover { background-color: rgba(255,255,255,0.03); }
        .comment-item { padding: 12px 16px; border-bottom: 1px solid #2f3336; display: flex; gap: 12px; }
        .like-anim { animation: likeBounce 0.4s; color: #f91880 !important; fill: #f91880; }
        @keyframes likeBounce { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        
        /* Unified Floating Button */
        .float-tweet-btn {
            position: absolute; bottom: 60px; right: 20px; 
            background: #1d9bf0; color: #fff; width: 44px; height: 44px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 60; transition: transform 0.2s;
        }
        .float-tweet-btn:active { transform: scale(0.9); }

        /* --- Google Styles --- */
        #mp-google { background: #202124; color: #e8eaed; }
        .google-container { min-height: 100%; padding-bottom: 60px; font-family: 'Google Sans', arial, sans-serif; }
        .google-header { padding: 16px; border-bottom: 1px solid #3c4043; }
        .fake-search-bar { 
            display: flex; align-items: center; background: #303134; border-radius: 9999px; padding: 10px 16px; gap: 12px;
            border: 1px solid transparent; 
        }
        .fake-search-bar input { background: transparent; border: none; outline: none; flex: 1; color: #e8eaed; font-size: 0.9rem; }
        .google-subheader { padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; color: #9aa0a6; font-size: 0.75rem; font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase; }
        .search-item { padding: 12px 20px; display: flex; gap: 16px; align-items: flex-start; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid #202124; }
        .search-item:hover { background-color: rgba(232, 234, 237, 0.04); }
        .icon-circle { padding: 8px; border-radius: 50%; margin-top: 2px; }
        .bg-blue-dark { background: rgba(66, 133, 244, 0.2); } .text-blue-glow { color: #8ab4f8; }
        .bg-purple-dark { background: rgba(161, 66, 244, 0.2); } .text-purple-glow { color: #c58af9; }
        .bg-green-dark { background: rgba(52, 168, 83, 0.2); } .text-green-glow { color: #81c995; }
        .search-content { flex: 1; }
        .search-title { font-size: 0.95rem; font-weight: 500; color: #e8eaed; display: flex; justify-content: space-between; }
        .search-time { font-size: 0.75rem; color: #9aa0a6; margin-left: 10px; font-weight: normal; }
        .search-meta { font-size: 0.75rem; color: #9aa0a6; margin-top: 2px; }
        .ai-thought-box { margin-top: 6px; font-size: 0.75rem; color: #fcad70; display: flex; align-items: flex-start; gap: 6px; }

        /* --- Summon Tab --- */
        .summon-box {
            background: #2c3e50; color: #ecf0f1; padding: 20px; border-radius: 12px;
            font-family: monospace; font-size: 0.9rem; min-height: 200px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3); border: 1px solid #34495e;
            white-space: pre-wrap; line-height: 1.6;
        }

        /* --- Taobao Styles --- */
        #mp-taobao { background: #f4f4f4; color: #333; }
        .tb-orange { color: #ff5000; }
        .bg-tb-orange { background-color: #ff5000; }
        .order-card { border-radius: 12px; background: white; margin-bottom: 12px; }
        .status-tag { color: #ff5000; font-size: 13px; font-weight: bold; }
        .tb-container { padding: 15px; padding-bottom: 80px; min-height: 100%; }

    </style>
</head>
<body>

    <!-- 1. å°é¢ -->
    <div id="cover-page" onclick="enterApp()">
        <div class="brand-title">MistCall</div>
        <div class="tap-hint">Tap to Start</div>
    </div>

    <!-- 2. ä¸»ç¨‹åº -->
    <div id="main-app">
        <div class="header">
            <div class="header-icon" style="opacity:0;"><i data-lucide="menu"></i></div>
            <div class="header-title" id="nav-title">æ¶ˆæ¯</div>
            <div class="header-icon" id="header-plus" onclick="openAgentEditor(-1)"><i data-lucide="plus"></i></div>
            <div class="header-icon" id="header-right-space" style="display:none; opacity:0;"></div>
        </div>

        <div class="content-area">
            <div id="tab-msg" class="tab-page active">
                <div id="agent-list-container"></div>
            </div>
            <div id="tab-style" class="tab-page">
                <!-- ç¾åŒ–ä¸­å¿ƒå°†ç”±JavaScriptåŠ¨æ€æ¸²æŸ“ -->
                <div id="style-content" style="padding:20px;">
                    <div style="text-align:center; padding-top:60px; color:#bdc3c7;">
                        <i data-lucide="sparkles" style="width:48px; height:48px; margin:0 auto 10px; display:block; opacity:0.5;"></i>
                        åŠ è½½ä¸»é¢˜å•†åŸä¸­...
                    </div>
                </div>
            </div>
            <!-- Tab Me -->
            <div id="tab-me" class="tab-page">
                <div class="settings-card" style="margin-top:15px; padding:20px 0; text-align:center;">
                    <img id="my-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" style="width:70px; height:70px; border-radius:50%; border:1px solid #eee; margin: 0 auto; display: block;">
                    <input type="text" id="my-name" value="MistUser" style="display:block; margin:10px auto 0; border:none; text-align:center; font-size:1.2rem; font-weight:bold; color:#2c3e50;">
                </div>
                <div class="settings-card">
                    <div class="card-header">æ¨¡å‹è®¾ç½®</div>
                    <div class="field-row">
                        <label class="field-label">API åœ°å€</label>
                        <input type="text" id="api-url" class="field-input" placeholder="https://api.deepseek.com">
                    </div>
                    <div class="field-row">
                        <label class="field-label">API å¯†é’¥</label>
                        <div class="input-group">
                            <input type="password" id="api-key" class="field-input" placeholder="sk-...">
                            <button class="btn-mini" id="conn-btn" onclick="fetchModels()">è¿æ¥æµ‹è¯•</button>
                        </div>
                    </div>
                    <div class="field-row">
                        <label class="field-label">å½“å‰æ¨¡å‹</label>
                        <div class="input-group">
                            <input type="text" id="model-id" class="field-input" placeholder="é€‰æ‹©æˆ–è¾“å…¥...">
                        </div>
                        <div class="model-list-pop" id="model-pop">
                            <input type="text" placeholder="ğŸ” æœç´¢æ¨¡å‹..." style="width:100%; padding:8px; border:none; border-bottom:1px solid #eee;" onkeyup="filterModels(this.value)">
                            <div id="model-list-ul"></div>
                        </div>
                    </div>
                </div>
                <div class="settings-card">
                    <div class="card-header">MiniMax è¯­éŸ³</div>
                    <div class="field-row">
                        <label class="field-label">Group ID</label>
                        <input type="text" id="mm-group" class="field-input" placeholder="Group ID">
                    </div>
                    <div class="field-row">
                        <label class="field-label">API Key</label>
                        <input type="password" id="mm-key" class="field-input" placeholder="API Key">
                    </div>
                </div>
                <!-- Save Button -->
                <div class="normal-save-container">
                    <button class="btn-save" onclick="saveGlobalSettings()">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" id="nav-msg" onclick="switchTab('msg', this)"><i data-lucide="message-circle"></i><span>æ¶ˆæ¯</span></div>
            <div class="nav-item" id="nav-style" onclick="switchTab('style', this)"><i data-lucide="palette"></i><span>ç¾åŒ–</span></div>
            <div class="nav-item" id="nav-me" onclick="switchTab('me', this)"><i data-lucide="user"></i><span>æˆ‘</span></div>
        </div>
    </div>

    <!-- 3. æ™ºèƒ½ä½“ç¼–è¾‘å™¨ -->
    <div id="agent-editor">
        <div class="editor-nav">
            <div onclick="closeAgentEditor()" style="color:#e74c3c; cursor:pointer;">å–æ¶ˆ</div>
            <div style="font-weight:bold;">ç¼–è¾‘æ™ºèƒ½ä½“</div>
            <div onclick="saveAgent()" style="color:#27ae60; font-weight:bold; cursor:pointer;">å®Œæˆ</div>
        </div>

        <div class="visual-editor">
            <div class="bg-upload-zone" onclick="document.getElementById('edit-bg-in').click()">
                <div class="plus-icon" id="bg-plus"><i data-lucide="image-plus" color="white" size="32"></i></div>
                <img id="bg-preview-img" style="display:none;">
                <video id="bg-preview-video" muted loop style="display:none;"></video>
            </div>
            <div class="avatar-upload-zone" onclick="document.getElementById('edit-avatar-in').click()">
                <div class="avatar-plus" id="av-plus"><i data-lucide="camera" color="#ccc"></i></div>
                <img id="av-preview-img" style="display:none;">
            </div>
            <input type="file" id="edit-bg-in" hidden accept="image/*,video/*" onchange="handleFilePreview(this, 'bg')">
            <input type="file" id="edit-avatar-in" hidden accept="image/*" onchange="handleFilePreview(this, 'avatar')">
        </div>

        <div class="editor-form">
            <div class="form-section">
                <div class="input-group">
                    <input type="text" id="edit-name" class="edit-input" placeholder="æ™ºèƒ½ä½“åå­—" style="flex:2;">
                    <select id="edit-gender" class="edit-input">
                        <option value="male">ç”·</option>
                        <option value="female">å¥³</option>
                    </select>
                </div>
            </div>
            <div class="form-section">
                <div class="section-label">éŸ³è‰² ID</div>
                <input type="text" id="edit-voice" class="edit-input" placeholder="è¾“å…¥ Voice ID">
            </div>
            <div class="form-section">
                <div class="section-label">Taçš„è®¾å®š</div>
                <div class="textarea-wrapper">
                    <div class="expand-btn" onclick="openFullscreen('edit-persona')"><i data-lucide="scan" size="14"></i></div>
                    <textarea id="edit-persona" class="edit-area" placeholder="æ€§æ ¼ã€ç»å†ã€èƒŒæ™¯..." oninput="updateCount('persona', 5000)"></textarea>
                </div>
                <div class="char-limit"><span id="c-persona">0</span>/5000</div>
            </div>
            <div class="form-section">
                <div class="section-label">å¯¹è¯é£æ ¼</div>
                <div class="textarea-wrapper">
                    <div class="expand-btn" onclick="openFullscreen('edit-style')"><i data-lucide="scan" size="14"></i></div>
                    <textarea id="edit-style" class="edit-area" placeholder="è¯´è¯è¯­æ°”ã€å£ç™–..." oninput="updateCount('style', 2000)"></textarea>
                </div>
                <div class="char-limit"><span id="c-style">0</span>/2000</div>
            </div>
            <div class="form-section">
                <div class="section-label">è”åŠ¨äººç‰©</div>
                <div class="textarea-wrapper">
                    <div class="expand-btn" onclick="openFullscreen('edit-relation')"><i data-lucide="scan" size="14"></i></div>
                    <textarea id="edit-relation" class="edit-area" placeholder="ç›¸å…³äººç‰©å…³ç³»..." oninput="updateCount('relation', 3000)"></textarea>
                </div>
                <div class="char-limit"><span id="c-relation">0</span>/3000</div>
            </div>
            <div class="form-section">
                <div class="section-label">å¼€åœºç™½</div>
                <div class="textarea-wrapper">
                    <div class="expand-btn" onclick="openFullscreen('edit-opening')"><i data-lucide="scan" size="14"></i></div>
                    <textarea id="edit-opening" class="edit-area" placeholder="Taå¯¹ä½ è¯´çš„ç¬¬ä¸€å¥è¯..." oninput="updateCount('opening', 1000)"></textarea>
                </div>
                <div class="char-limit"><span id="c-opening">0</span>/1000</div>
            </div>
        </div>
    </div>

    <!-- å…¨å±è¾“å…¥ -->
    <div id="fullscreen-editor">
        <div class="fs-header">
            <div class="fs-done" onclick="closeFullscreen()">å®Œæˆ</div>
        </div>
        <textarea id="fs-input-area" class="fs-input" placeholder="åœ¨æ­¤è¾“å…¥..."></textarea>
    </div>

    <!-- 4. èŠå¤©å®¤ -->
    <div id="chat-room">
        <div class="chat-bg-layer" id="chat-bg-container"></div>
        <div class="chat-overlay"></div>
        <div class="chat-header-trans">
            <div onclick="closeChat()" style="cursor:pointer; padding:5px;"><i data-lucide="chevron-left" color="white"></i></div>
            <div id="chat-title">Chat</div>
            <div onclick="editCurrentAgent()" style="cursor:pointer; padding:5px;"><i data-lucide="edit-3" color="white" size="18"></i></div>
        </div>
        <div class="chat-main" id="chat-box"></div>
        
        <!-- More Panel -->
        <div id="more-panel">
            <div class="more-header">
                æ›´å¤šåŠŸèƒ½
                <div class="more-close" onclick="toggleMoreDrawer(false)"><i data-lucide="x"></i></div>
            </div>
            <!-- ä¿®æ”¹åçš„é¡ºåºï¼šå¬å”¤ã€æ¨ç‰¹ã€è°·æ­Œã€æ·˜å®ã€äº‹ä»¶ã€è‡ªè®¾ã€å­˜æ¡£ -->
            <div class="more-tabs">
                <div class="more-tab active" onclick="jumpMoreTab('summon')"><i data-lucide="users"></i>å¬å”¤</div>
                <div class="more-tab" onclick="jumpMoreTab('tweet')"><i data-lucide="twitter"></i>æ¨ç‰¹</div>
                <div class="more-tab" onclick="jumpMoreTab('google')"><i data-lucide="chrome"></i>è°·æ­Œ</div>
                <div class="more-tab" onclick="jumpMoreTab('taobao')"><i data-lucide="shopping-bag"></i>æ·˜å®</div>
                <div class="more-tab" onclick="jumpMoreTab('event')"><i data-lucide="book"></i>äº‹ä»¶</div>
                <div class="more-tab" onclick="jumpMoreTab('user')"><i data-lucide="user-cog"></i>è‡ªè®¾</div>
                <div class="more-tab" onclick="jumpMoreTab('slot')"><i data-lucide="save"></i>å­˜æ¡£</div>
            </div>
            
            <!-- å¬å”¤é¡µï¼ˆç°åœ¨ç¬¬ä¸€ä¸ªï¼‰ -->
            <div id="mp-summon" class="more-content active">
                <div class="more-inner-pad">
                    <div style="font-size:0.85rem; color:#666; margin-bottom:10px;">å¬å”¤ã€è”åŠ¨äººç‰©ã€‘è¿›è¡Œäº’åŠ¨ï¼Œç”Ÿæˆçš„å†…å®¹å°†å½±å“ä¸‹ä¸€å¥å‰§æƒ…èµ°å‘ã€‚</div>
                    <div id="summon-output" class="summon-box">
                        <span style="opacity:0.5; font-style:italic;">(ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¬å”¤é…è§’/æ—ç™½...)</span>
                    </div>
                    <div class="float-tweet-btn" style="background:#9b59b6;" onclick="generateSummon()">
                        <i data-lucide="zap" class="w-5 h-5"></i>
                    </div>
                </div>
            </div>

            <!-- æ¨ç‰¹é¡µï¼ˆç°åœ¨ç¬¬äºŒä¸ªï¼‰ -->
            <div id="mp-tweet" class="more-content" style="background:#000;">
                <div class="twitter-container w-full max-w-[600px] mx-auto bg-black text-gray-200 relative">
                    <div class="relative group">
                        <label for="tw-banner-up" class="cursor-pointer block h-32 bg-gray-800 relative overflow-hidden">
                            <img id="tw-banner" src="https://images.unsplash.com/photo-1614850523296-d8c1af93d400?q=80&w=1000" class="w-full h-full object-cover opacity-80">
                            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 bg-black/30 transition">
                                <i data-lucide="camera" class="text-white"></i>
                            </div>
                        </label>
                        <input type="file" id="tw-banner-up" class="file-input" accept="image/*" onchange="previewImage(this, 'tw-banner')">
                        <div class="px-4 relative -mt-10 flex justify-between items-end">
                            <label for="tw-avatar-up" class="relative group cursor-pointer">
                                <div class="w-20 h-20 rounded-full border-4 border-black overflow-hidden bg-gray-900">
                                    <img id="tw-avatar" src="" class="w-full h-full object-cover">
                                </div>
                                <div class="absolute inset-0 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 bg-black/40 transition">
                                    <i data-lucide="camera" class="text-white w-5 h-5"></i>
                                </div>
                            </label>
                            <input type="file" id="tw-avatar-up" class="file-input" accept="image/*" onchange="previewImage(this, 'tw-avatar')">
                            <button class="bg-white text-black px-4 py-1.5 rounded-full font-bold text-sm mb-1">æ­£åœ¨å…³æ³¨</button>
                        </div>
                    </div>
                    <div class="px-4 py-3 border-b border-gray-800">
                        <h1 class="text-lg font-bold text-white" id="tw-name">Agent Name</h1>
                        <p class="text-gray-500 text-sm" id="tw-handle">@agent_id</p>
                        <p class="mt-2 text-[14px] text-gray-300" id="tw-bio">Loading bio...</p>
                        <div class="flex gap-4 mt-2 text-xs text-gray-500">
                            <span class="flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i> Tokyo, Japan</span>
                            <span class="flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> 2023å¹´åŠ å…¥</span>
                        </div>
                    </div>
                    <div class="flex font-bold border-b border-gray-800 text-sm">
                        <div class="flex-1 text-center py-3 text-white border-b-2 border-[#1d9bf0]">å¸–å­</div>
                        <div class="flex-1 text-center py-3 text-gray-500">å›å¤</div>
                        <div class="flex-1 text-center py-3 text-gray-500">åª’ä½“</div>
                    </div>
                    <div id="tweet-list-render"></div>
                    <div class="float-tweet-btn" onclick="generateSocialPost()">
                        <i data-lucide="sparkles" class="w-5 h-5"></i>
                    </div>
                </div>
            </div>

            <!-- Google -->
            <div id="mp-google" class="more-content">
                <div class="google-container w-full max-w-[500px] mx-auto">
                    <div class="google-header">
                        <div class="fake-search-bar">
                            <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                            <input type="text" placeholder="æœç´¢ä½ çš„æ´»åŠ¨è®°å½•" disabled>
                            <i data-lucide="mic" class="w-4 h-4 text-blue-400"></i>
                        </div>
                    </div>
                    <div class="google-subheader">
                        <span>æœ€è¿‘çš„æœç´¢æ´»åŠ¨</span>
                        <i data-lucide="info" class="w-3 h-3"></i>
                    </div>
                    <div id="browser-list-render">
                        <div style="padding:40px; text-align:center; color:#5f6368; font-size:0.9rem;">æš‚æ— æœç´¢è®°å½•</div>
                    </div>
                    <div class="float-tweet-btn" style="background:#4285f4;" onclick="generateSearchHistory()">
                        <i data-lucide="search" class="w-5 h-5"></i>
                    </div>
                </div>
            </div>

            <!-- Taobao (New) -->
            <div id="mp-taobao" class="more-content">
                <div class="tb-container w-full max-w-[480px] mx-auto">
                    <div class="flex items-center justify-between mb-4 px-2">
                        <h1 class="text-xl font-bold">æˆ‘çš„è®¢å•</h1>
                        <div class="flex gap-4 text-gray-500">
                            <i data-lucide="search" class="w-5 h-5"></i>
                            <i data-lucide="list-filter" class="w-5 h-5"></i>
                        </div>
                    </div>
                    <div class="flex justify-around bg-white py-3 rounded-xl mb-4 shadow-sm text-sm">
                        <div class="flex flex-col items-center gap-1"><i data-lucide="wallet" class="w-5 h-5 text-gray-600"></i><span>å¾…ä»˜æ¬¾</span></div>
                        <!-- Dynamic Badge Here -->
                        <div class="flex flex-col items-center gap-1 relative">
                            <i data-lucide="package" class="w-5 h-5 text-gray-600"></i>
                            <span>å¾…å‘è´§</span>
                            <span id="tb-badge" class="absolute -top-1 -right-2 bg-tb-orange text-white text-[10px] px-1 rounded-full" style="display:none;">0</span>
                        </div>
                        <div class="flex flex-col items-center gap-1"><i data-lucide="truck" class="w-5 h-5 text-gray-600"></i><span>å¾…æ”¶è´§</span></div>
                        <div class="flex flex-col items-center gap-1 text-tb-orange font-bold"><i data-lucide="message-square-more" class="w-5 h-5"></i><span>å¾…è¯„ä»·</span></div>
                    </div>
                    
                    <div id="tb-list-render">
                        <div style="padding:40px; text-align:center; color:#999; font-size:0.9rem;">æš‚æ— æ–°è®¢å•</div>
                    </div>

                    <div class="float-tweet-btn" style="background:#ff5000;" onclick="generateTaobaoOrder()">
                        <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                    </div>
                </div>
            </div>

            <!-- äº‹ä»¶ç°¿ -->
            <div id="mp-event" class="more-content">
                <div class="more-inner-pad">
                    <div class="textarea-wrapper">
                        <div class="expand-btn" onclick="openFullscreen('event-book')"><i data-lucide="scan" size="14"></i></div>
                        <textarea id="event-book" class="edit-area" style="height:200px;" placeholder="AIè‡ªåŠ¨æ€»ç»“è®°å¿†åŒºåŸŸ..." oninput="updateMemoryData(this.value)"></textarea>
                    </div>
                    <div class="char-limit"><span id="c-event">0</span>/5000</div>
                    <p style="font-size:0.75rem; color:#999; margin-top:5px;">* AIä¼šè‡ªåŠ¨æ€»ç»“ï¼Œè¶…é™å°†é—å¿˜æœ€æ—§è®°å¿†ã€‚</p>
                </div>
            </div>
            
            <!-- è‡ªè®¾ -->
            <div id="mp-user" class="more-content">
                <div class="more-inner-pad">
                    <div class="textarea-wrapper">
                        <div class="expand-btn" onclick="openFullscreen('user-persona')"><i data-lucide="scan" size="14"></i></div>
                        <textarea id="user-persona" class="edit-area" style="height:200px;" placeholder="åœ¨æ­¤è®¾å®šæ‚¨åœ¨è¿™ä¸ªæ•…äº‹ä¸­æ‰®æ¼”çš„è§’è‰²..." oninput="updateUserPersona(this.value)"></textarea>
                    </div>
                    <div class="char-limit"><span id="c-userp">0</span>/5000</div>
                </div>
            </div>

            <!-- å­˜æ¡£ -->
            <div id="mp-slot" class="more-content">
                <div class="more-inner-pad">
                    <p style="text-align:center; color:#7f8c8d; font-size:0.9rem;">åˆ‡æ¢å­˜æ¡£å°†é‡ç½®å½“å‰èŠå¤©è§†å›¾</p>
                    <div class="slot-container">
                        <div class="save-slot active" id="slot-0" onclick="switchSlot(0)">
                            <i data-lucide="folder" size="24"></i><small>å­˜æ¡£ 1</small><div class="slot-badge"></div>
                        </div>
                        <div class="save-slot" id="slot-1" onclick="switchSlot(1)">
                            <i data-lucide="folder" size="24"></i><small>å­˜æ¡£ 2</small><div class="slot-badge"></div>
                        </div>
                        <div class="save-slot" id="slot-2" onclick="switchSlot(2)">
                            <i data-lucide="folder" size="24"></i><small>å­˜æ¡£ 3</small><div class="slot-badge"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="swipe-handle-bar">
                <div class="swipe-indicator"></div>
            </div>
        </div>

        <div class="chat-footer">
            <input type="text" id="msg-in" placeholder="å‘é€æ¶ˆæ¯..." onkeypress="if(event.keyCode===13) sendMsg()">
            <div class="icon-btn send-btn" onclick="sendMsg()">
                <i data-lucide="send-horizontal"></i>
            </div>
            <div class="icon-btn" onclick="toggleMoreDrawer(true)">
                <i data-lucide="layout-grid"></i>
            </div>
        </div>
    </div>

    <script>
        let agents = []; 
        let currentAgentIdx = -1;
        let editingAgentIdx = -1; 
        let currentSlot = 0; 
        let allModels = [];
        let activeTextareaId = '';
        let tempBlobAvatar = null;
        let tempBlobBg = null;
        let tempBgType = 'img';
        
        // ä¿®æ”¹åçš„é¡ºåºï¼šå¬å”¤ã€æ¨ç‰¹ã€è°·æ­Œã€æ·˜å®ã€äº‹ä»¶ã€è‡ªè®¾ã€å­˜æ¡£
        const drawerTabs = ['summon', 'tweet', 'google', 'taobao', 'event', 'user', 'slot'];
        let currentDrawerTabIdx = 0; // Default: summon

        let tempSummonContext = "";
        let autoSummaryCounter = 0; // ç”¨äºè®°å½•å¯¹è¯è½®æ¬¡ï¼Œç”¨äºè‡ªåŠ¨æ€»ç»“
        const SUMMARY_INTERVAL = 5; // æ¯5è½®å¯¹è¯è‡ªåŠ¨æ€»ç»“ä¸€æ¬¡

        // ç¾åŒ–å•†åŸæ•°æ® - åªä¿ç•™çº¢ç«ç‘°ä¸»é¢˜
        const mallThemes = [
            {
                name: "çº¢ç«ç‘°",
                preview: "https://gitee.com/mistcall/mc/raw/master/IMG_2320.jpeg",
                jsonUrl: "https://gitee.com/mistcall/mc/raw/master/theme_red_rose.json"
            }
        ];

        // çº¢ç«ç‘°ä¸»é¢˜å¤‡ç”¨é…ç½® - æ·»åŠ UIé€æ˜é…ç½®
        function getRedRoseFallback() {
            return {
                id: "red_rose",
                name: "çº¢ç«ç‘°",
                preview: "https://gitee.com/mistcall/mc/raw/master/IMG_2320.jpeg",
                config: {
                    ui: {
                        header_bg: "rgba(255,255,255,0.8)",
                        nav_bg: "rgba(255,255,255,0.95)",
                        card_bg: "rgba(255,255,255,0.9)",
                        blur: "8px",
                        text_main: "#1e293b",
                        text_sub: "#94a3b8",
                        icon_size: "24px"
                    },
                    colors: {
                        main_text: "#ffffff",
                        input_text: "#333333",
                        nav_active: "#ff4d4d"
                    },
                    backgrounds: {
                        page_bg: "https://gitee.com/mistcall/mc/raw/master/IMG_2322.jpeg",
                        msg_tab_bg: "https://gitee.com/mistcall/mc/raw/master/IMG_2318.jpeg",
                        style_tab_bg: "https://gitee.com/mistcall/mc/raw/master/IMG_2316.jpeg",
                        input_box_bg: "https://gitee.com/mistcall/mc/raw/master/IMG_2321.jpeg"
                    },
                    icons: {
                        msg: "https://gitee.com/mistcall/mc/raw/master/IMG_2314.png",
                        style: "https://gitee.com/mistcall/mc/raw/master/IMG_2313.png",
                        me: "https://gitee.com/mistcall/mc/raw/master/IMG_2317.png"
                    },
                    bubbles: {
                        bot: {
                            img: "https://gitee.com/mistcall/mc/raw/master/IMG_2319.png",
                            slice: "41 158 48 26 fill",
                            width: "41px 158px 48px 26px",
                            padding: "10px 60px 10px 20px",
                            minHeight: "100px",
                            textColor: "#ffffff"
                        },
                        user: {
                            img: "https://gitee.com/mistcall/mc/raw/master/IMG_2315.png",
                            slice: "122 152 173 113 fill",
                            width: "122px 152px 173px 113px",
                            padding: "60px 80px 80px 60px",
                            minHeight: "150px",
                            textColor: "#ffffff"
                        }
                    }
                }
            };
        }

        // æ¸²æŸ“å•†åŸåˆ—è¡¨ - ä¿®æ”¹ï¼šç¼©å°é¢„è§ˆå›¾
        function renderMall() {
            const container = document.getElementById('style-content');
            container.innerHTML = `
                <div style="padding:20px;">
                    <h2 style="font-size:1.2rem; font-weight:bold; margin-bottom:20px; color:#2c3e50; text-align:center;">ä¸»é¢˜å•†åŸ</h2>
                    <div class="grid grid-cols-2 gap-4">
                        ${mallThemes.map(t => `
                            <div class="bg-white rounded-xl overflow-hidden shadow-md border border-gray-200">
                                <img src="${t.preview}" class="w-full h-32 object-cover" style="height:128px;">
                                <div class="p-3 text-center">
                                    <div class="font-bold text-sm mb-2">${t.name}</div>
                                    <button onclick="installTheme('${t.jsonUrl}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-full text-sm font-medium transition-colors">å®‰è£…å¹¶æ¢è‚¤</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top:30px; padding:15px; background:#f8f9fa; border-radius:8px;">
                        <h3 class="font-bold text-sm mb-2">å¦‚ä½•ä½¿ç”¨ä¸»é¢˜ï¼Ÿ</h3>
                        <p class="text-xs text-gray-600">1. ç‚¹å‡»"å®‰è£…å¹¶æ¢è‚¤"æŒ‰é’®å®‰è£…ä¸»é¢˜</p>
                        <p class="text-xs text-gray-600">2. ä¸»é¢˜ä¼šè‡ªåŠ¨åº”ç”¨åˆ°å½“å‰ç•Œé¢</p>
                        <p class="text-xs text-gray-600">3. åˆ‡æ¢å›"æ¶ˆæ¯"æ ‡ç­¾æŸ¥çœ‹æ•ˆæœ</p>
                        <p class="text-xs text-gray-600 mt-2 text-red-500">* å¦‚æœä¸»é¢˜åŠ è½½å¤±è´¥ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨å¤‡ç”¨é…ç½®</p>
                    </div>
                </div>
            `;
        }

        // æ ¸å¿ƒï¼šå®‰è£…ä¸»é¢˜é€»è¾‘ - æ›´æ–°ä¸ºæ”¯æŒæ²‰æµ¸å¼UI
        async function installTheme(url) {
            let themeData = null;
            const btn = document.querySelector('#style-content button');
            
            try {
                if (btn) {
                    btn.innerText = "å®‰è£…ä¸­...";
                    btn.disabled = true;
                }
                
                // å°è¯•ä»ç½‘ç»œåŠ è½½ä¸»é¢˜
                try {
                    const res = await fetch(url, {
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (!res.ok) {
                        throw new Error(`HTTPé”™è¯¯: ${res.status}`);
                    }
                    
                    themeData = await res.json();
                    console.log('ä»ç½‘ç»œåŠ è½½ä¸»é¢˜æˆåŠŸ:', themeData);
                } catch (networkError) {
                    console.warn('ç½‘ç»œåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨é…ç½®:', networkError);
                    // ä½¿ç”¨å¤‡ç”¨é…ç½®
                    themeData = getRedRoseFallback();
                    console.log('ä½¿ç”¨å¤‡ç”¨ä¸»é¢˜é…ç½®:', themeData);
                }
                
                applyTheme(themeData);
                
                alert('"çº¢ç«ç‘°"ä¸»é¢˜å®‰è£…æˆåŠŸï¼è¯·åˆ‡æ¢åˆ°"æ¶ˆæ¯"æ ‡ç­¾æŸ¥çœ‹æ•ˆæœã€‚');
                
            } catch (e) {
                console.error('ä¸»é¢˜å®‰è£…å¤±è´¥:', e);
                alert(`ä¸»é¢˜å®‰è£…å¤±è´¥: ${e.message}\nå·²è‡ªåŠ¨ä½¿ç”¨å¤‡ç”¨é…ç½®ã€‚`);
            } finally {
                if (btn) {
                    btn.innerText = "å®‰è£…å¹¶æ¢è‚¤";
                    btn.disabled = false;
                }
            }
        }

        // åº”ç”¨ä¸»é¢˜å‡½æ•° - æ²‰æµ¸å¼UIç‰ˆæœ¬
        function applyTheme(themeData) {
            const theme = themeData.config || themeData;
            const root = document.documentElement;

            // 1. åº”ç”¨æ²‰æµ¸å¼ UI (é€æ˜åº¦ã€æ¨¡ç³Šã€æ–‡å­—é¢œè‰²)
            if(theme.ui) {
                root.style.setProperty('--ui-header-bg', theme.ui.header_bg);
                root.style.setProperty('--ui-nav-bg', theme.ui.nav_bg);
                root.style.setProperty('--ui-card-bg', theme.ui.card_bg);
                root.style.setProperty('--ui-text-main', theme.ui.text_main);
                root.style.setProperty('--ui-text-sub', theme.ui.text_sub);
                root.style.setProperty('--ui-blur', theme.ui.blur);
                root.style.setProperty('--ui-icon-size', theme.ui.icon_size);
                
                // åŒæ—¶è®¾ç½®åŸæœ‰çš„å˜é‡ï¼ˆå‘åå…¼å®¹ï¼‰
                root.style.setProperty('--header-bg', theme.ui.header_bg);
                root.style.setProperty('--nav-bg', theme.ui.nav_bg);
                root.style.setProperty('--card-bg', theme.ui.card_bg);
                root.style.setProperty('--text-color', theme.ui.text_main);
                root.style.setProperty('--ui-blur', theme.ui.blur);
            }

            // 2. åº”ç”¨åº•å›¾
            if (theme.backgrounds) {
                root.style.setProperty('--page-bg-img', `url(${theme.backgrounds.page_bg})`);
                // åŒæ—¶è®¾ç½®åŸæœ‰çš„èƒŒæ™¯å˜é‡
                root.style.setProperty('--page-bg', `url('${theme.backgrounds.page_bg}')`);
                if (theme.backgrounds.msg_tab_bg) {
                    root.style.setProperty('--msg-bg', `url('${theme.backgrounds.msg_tab_bg}')`);
                }
                if (theme.backgrounds.style_tab_bg) {
                    root.style.setProperty('--style-bg', `url('${theme.backgrounds.style_tab_bg}')`);
                }
                if (theme.backgrounds.input_box_bg) {
                    root.style.setProperty('--input-bg', `url('${theme.backgrounds.input_box_bg}')`);
                }
            }

            // 3. åº”ç”¨æ°”æ³¡ (ä½¿ç”¨ JSON é‡Œçš„æ–°æ•°å€¼)
            if (theme.bubbles) {
                const b = theme.bubbles;
                
                // æœºå™¨äººæ°”æ³¡
                if (b.bot) {
                    root.style.setProperty('--bot-bubble-img', `url(${b.bot.img})`);
                    root.style.setProperty('--bot-bubble-slice', b.bot.slice);
                    root.style.setProperty('--bot-bubble-width', b.bot.width);
                    root.style.setProperty('--bot-bubble-padding', b.bot.padding);
                    root.style.setProperty('--bot-min-h', b.bot.minHeight);
                    root.style.setProperty('--bot-text-color', b.bot.textColor);
                    
                    // åŒæ—¶è®¾ç½®åŸæœ‰çš„æ°”æ³¡å˜é‡ï¼ˆå‘åå…¼å®¹ï¼‰
                    root.style.setProperty('--bot-bubble-img', `url('${b.bot.img}')`);
                    root.style.setProperty('--bot-bubble-slice', b.bot.slice);
                    root.style.setProperty('--bot-bubble-width', b.bot.width);
                    root.style.setProperty('--bot-bubble-padding', b.bot.padding);
                    root.style.setProperty('--bot-bubble-min-height', b.bot.minHeight);
                    root.style.setProperty('--bot-bubble-text-color', b.bot.textColor);
                }
                
                // ç”¨æˆ·æ°”æ³¡
                if (b.user) {
                    root.style.setProperty('--user-bubble-img', `url(${b.user.img})`);
                    root.style.setProperty('--user-bubble-slice', b.user.slice);
                    root.style.setProperty('--user-bubble-width', b.user.width);
                    root.style.setProperty('--user-bubble-padding', b.user.padding);
                    root.style.setProperty('--user-min-h', b.user.minHeight);
                    root.style.setProperty('--user-text-color', b.user.textColor);
                    
                    // åŒæ—¶è®¾ç½®åŸæœ‰çš„æ°”æ³¡å˜é‡ï¼ˆå‘åå…¼å®¹ï¼‰
                    root.style.setProperty('--user-bubble-img', `url('${b.user.img}')`);
                    root.style.setProperty('--user-bubble-slice', b.user.slice);
                    root.style.setProperty('--user-bubble-width', b.user.width);
                    root.style.setProperty('--user-bubble-padding', b.user.padding);
                    root.style.setProperty('--user-bubble-min-height', b.user.minHeight);
                    root.style.setProperty('--user-bubble-text-color', b.user.textColor);
                }
            }

            // 4. æ›¿æ¢å›¾æ ‡
            if (theme.icons) {
                const msgIcon = document.getElementById('nav-msg');
                const styleIcon = document.getElementById('nav-style');
                const meIcon = document.getElementById('nav-me');
                
                if (msgIcon) {
                    msgIcon.innerHTML = `<img src="${theme.icons.msg}" style="width:42px; height:42px; object-fit:contain; margin-bottom:-2px;"><span>æ¶ˆæ¯</span>`;
                }
                if (styleIcon) {
                    styleIcon.innerHTML = `<img src="${theme.icons.style}" style="width:42px; height:42px; object-fit:contain; margin-bottom:-2px;"><span>ç¾åŒ–</span>`;
                }
                if (meIcon) {
                    meIcon.innerHTML = `<img src="${theme.icons.me}" style="width:42px; height:42px; object-fit:contain; margin-bottom:-2px;"><span>æˆ‘</span>`;
                }
            }
            
            // ä¿å­˜ä¸»é¢˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('saved_theme', JSON.stringify(theme));
            
            // é‡æ–°åˆ›å»ºå›¾æ ‡
            setTimeout(() => lucide.createIcons(), 100);
        }

        function enterApp() {
            document.getElementById('cover-page').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('cover-page').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                document.getElementById('header-plus').style.display = 'flex'; 
                setTimeout(() => document.getElementById('main-app').style.opacity = 1, 50);
                lucide.createIcons();
                initSwipeTabs();
                
                // åˆå§‹åŒ–ç¾åŒ–å•†åŸ
                renderMall();
            }, 600);
            loadSettings();
        }

        function switchTab(tab, el) {
            document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('nav-title').innerText = {'msg':'æ¶ˆæ¯', 'style':'ç¾åŒ–', 'me':'æˆ‘'}[tab];
            
            if(tab === 'msg') {
                document.getElementById('header-plus').style.display = 'flex';
                document.getElementById('header-right-space').style.display = 'none';
            } else {
                document.getElementById('header-plus').style.display = 'none';
                document.getElementById('header-right-space').style.display = 'block';
            }
            
            // åˆ‡æ¢åˆ°ç¾åŒ–æ ‡ç­¾æ—¶é‡æ–°æ¸²æŸ“å•†åŸ
            if (tab === 'style') {
                renderMall();
            }
        }

        /* --- Msg Swipe & Pin Logic --- */
        function renderAgents() {
            const con = document.getElementById('agent-list-container');
            con.innerHTML = '';
            
            const sortedIndices = agents.map((_, i) => i).sort((a, b) => {
                const pinA = agents[a].isPinned ? 1 : 0;
                const pinB = agents[b].isPinned ? 1 : 0;
                return pinB - pinA; 
            });

            sortedIndices.forEach((realIdx) => {
                const a = agents[realIdx];
                const wrapper = document.createElement('div');
                wrapper.className = 'msg-cell-wrapper';
                
                const content = document.createElement('div');
                content.className = 'msg-cell-content';
                if(a.isPinned) content.classList.add('is-pinned');
                content.onclick = () => openChat(realIdx);
                content.innerHTML = `
                    <img src="${a.avatar}" class="cell-avatar">
                    <div class="cell-content">
                        <h3>${a.name} <i data-lucide="pin" class="pin-icon"></i></h3>
                        <p>${a.opening || 'æš‚æ— å¼€åœºç™½...'}</p>
                    </div>
                `;

                const actions = document.createElement('div');
                actions.className = 'msg-cell-actions';
                actions.innerHTML = `
                    <div class="swipe-btn btn-pin" onclick="togglePin(${realIdx})">${a.isPinned ? 'å–æ¶ˆ' : 'ç½®é¡¶'}</div>
                    <div class="swipe-btn btn-del" onclick="deleteAgent(${realIdx})">åˆ é™¤</div>
                `;

                wrapper.appendChild(actions);
                wrapper.appendChild(content);
                con.appendChild(wrapper);

                let startX, currentX;
                content.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
                content.addEventListener('touchmove', e => {
                    currentX = e.touches[0].clientX;
                    let diff = currentX - startX;
                    if(diff < 0 && diff > -140) {
                        content.style.transform = `translateX(${diff}px)`;
                    }
                });
                content.addEventListener('touchend', e => {
                    let diff = currentX - startX;
                    if(diff < -60) {
                        content.style.transform = `translateX(-140px)`; 
                    } else {
                        content.style.transform = `translateX(0)`;
                    }
                });
            });
            lucide.createIcons();
        }

        function togglePin(idx) {
            agents.forEach((a, i) => {
                if(i !== idx) a.isPinned = false;
            });
            if(!agents[idx].isPinned) agents[idx].isPinned = true;
            else agents[idx].isPinned = false;
            renderAgents();
        }

        function deleteAgent(idx) {
            if(confirm("ç¡®è®¤åˆ é™¤è¯¥æ™ºèƒ½ä½“ï¼Ÿ")) {
                agents.splice(idx, 1);
                renderAgents();
            } else {
                renderAgents(); 
            }
        }

        /* --- Drawer Swipe Logic --- */
        function initSwipeTabs() {
            const panel = document.getElementById('more-panel');
            let startX, startY;
            panel.addEventListener('touchstart', e => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            });
            panel.addEventListener('touchmove', e => {
                let diffX = e.touches[0].clientX - startX;
                let diffY = e.touches[0].clientY - startY;
                
                // æ£€æµ‹å‘ä¸‹æ»‘åŠ¨ï¼ˆå…³é—­æ‰‹åŠ¿ï¼‰
                if (diffY > 50 && Math.abs(diffY) > Math.abs(diffX)) {
                    // å‘ä¸‹æ»‘åŠ¨è¶…è¿‡50åƒç´ ï¼Œå…³é—­é¢æ¿
                    toggleMoreDrawer(false);
                    return;
                }
            });
            panel.addEventListener('touchend', e => {
                let diffX = e.changedTouches[0].clientX - startX;
                let diffY = e.changedTouches[0].clientY - startY;
                
                // Ensure horizontal swipe
                if(Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    if(diffX > 0) { // Swipe Right -> Prev Tab
                        if(currentDrawerTabIdx > 0) jumpMoreTab(drawerTabs[currentDrawerTabIdx - 1]);
                    } else { // Swipe Left -> Next Tab
                        if(currentDrawerTabIdx < drawerTabs.length - 1) jumpMoreTab(drawerTabs[currentDrawerTabIdx + 1]);
                    }
                }
            });
        }
        
        function jumpMoreTab(tabName) {
            currentDrawerTabIdx = drawerTabs.indexOf(tabName);
            document.querySelectorAll('.more-tab').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.more-tab')[currentDrawerTabIdx].classList.add('active');
            document.querySelectorAll('.more-content').forEach(x => x.classList.remove('active'));
            document.getElementById('mp-' + tabName).classList.add('active');
            // Auto scroll nav into view
            document.querySelectorAll('.more-tab')[currentDrawerTabIdx].scrollIntoView({behavior: "smooth", block: "nearest", inline: "center"});
            lucide.createIcons();
        }

        /* --- Standard Functions --- */
        function cleanBaseUrl(url) {
            url = url.trim().replace(/\/+$/, '');
            if (url.endsWith('/chat/completions')) return url.replace('/chat/completions', '');
            if (url.endsWith('/models')) return url.replace('/models', '');
            return url;
        }

        async function fetchModels() {
            let url = document.getElementById('api-url').value;
            const key = document.getElementById('api-key').value.trim();
            const btn = document.getElementById('conn-btn');
            const pop = document.getElementById('model-pop');
            if(!url || !key) { alert('è¯·è¾“å…¥åœ°å€å’Œå¯†é’¥'); return; }
            btn.innerText = "è¿æ¥ä¸­...";
            let base = cleanBaseUrl(url);
            let target = base;
            if (target.endsWith('/v1')) target += '/models';
            else target += '/v1/models';
            try {
                const res = await fetch(target, { headers: { 'Authorization': `Bearer ${key}` } });
                if (!res.ok) throw new Error(res.status);
                const data = await res.json();
                if(data.data) {
                    allModels = data.data;
                    renderModelList(allModels);
                    pop.classList.add('show');
                    btn.innerText = "æˆåŠŸ";
                    btn.className = "btn-mini success";
                    alert("è¿æ¥æˆåŠŸï¼å…±åŠ è½½äº† " + allModels.length + " ä¸ªæ¨¡å‹ã€‚");
                } else throw new Error("æ— æ•°æ®");
            } catch(e) {
                btn.innerText = "å¤±è´¥";
                alert("è¿æ¥å¤±è´¥: " + e.message);
                allModels = [{id:'gpt-3.5-turbo'},{id:'gpt-4'},{id:'deepseek-chat'}];
                renderModelList(allModels);
                pop.classList.add('show');
            }
        }
        
        function renderModelList(list) {
            const ul = document.getElementById('model-list-ul');
            ul.innerHTML = '';
            list.forEach(m => {
                const div = document.createElement('div');
                div.className = 'model-opt';
                div.innerText = m.id;
                div.onclick = () => { document.getElementById('model-id').value = m.id; document.getElementById('model-pop').classList.remove('show'); };
                ul.appendChild(div);
            });
        }
        function filterModels(kw) { renderModelList(allModels.filter(m => m.id.toLowerCase().includes(kw.toLowerCase()))); }

        function updateCount(id, max) { 
            const val = document.getElementById('edit-' + id) ? document.getElementById('edit-' + id).value : document.getElementById(id).value;
            document.getElementById('c-' + id.replace('edit-','')).innerText = val.length; 
        }

        function openFullscreen(id) {
            activeTextareaId = id;
            document.getElementById('fs-input-area').value = document.getElementById(id).value;
            document.getElementById('fullscreen-editor').classList.add('open');
        }

        function closeFullscreen() {
            if(activeTextareaId) {
                const val = document.getElementById('fs-input-area').value;
                document.getElementById(activeTextareaId).value = val;
                if(activeTextareaId === 'event-book') updateMemoryData(val);
                else if(activeTextareaId === 'user-persona') updateUserPersona(val);
                else updateCount(activeTextareaId.replace('edit-', ''), 5000);
            }
            document.getElementById('fullscreen-editor').classList.remove('open');
        }

        function openAgentEditor(idx) {
            editingAgentIdx = idx;
            tempBlobAvatar = null; tempBlobBg = null; tempBgType = 'img';
            document.getElementById('bg-plus').style.display = 'flex';
            document.getElementById('bg-preview-img').style.display = 'none';
            document.getElementById('bg-preview-video').style.display = 'none';
            document.getElementById('av-plus').style.display = 'flex';
            document.getElementById('av-preview-img').style.display = 'none';

            if(idx > -1) {
                const a = agents[idx];
                document.getElementById('edit-name').value = a.name;
                document.getElementById('edit-gender').value = a.gender;
                document.getElementById('edit-voice').value = a.voiceId || '';
                document.getElementById('edit-persona').value = a.persona || '';
                document.getElementById('edit-style').value = a.style || '';
                document.getElementById('edit-relation').value = a.relation || '';
                document.getElementById('edit-opening').value = a.opening || '';
                
                if(a.avatar) {
                    document.getElementById('av-preview-img').src = a.avatar;
                    document.getElementById('av-preview-img').style.display = 'block';
                    document.getElementById('av-plus').style.display = 'none';
                    tempBlobAvatar = a.avatar;
                }
                if(a.bgSrc) {
                    tempBlobBg = a.bgSrc;
                    tempBgType = a.bgType;
                    if(a.bgType === 'video') {
                        const v = document.getElementById('bg-preview-video');
                        v.src = a.bgSrc; v.style.display = 'block';
                        document.getElementById('bg-preview-img').style.display = 'none';
                    } else {
                        const i = document.getElementById('bg-preview-img');
                        i.src = a.bgSrc; i.style.display = 'block';
                        document.getElementById('bg-preview-video').style.display = 'none';
                    }
                    document.getElementById('bg-plus').style.display = 'none';
                }
            } else {
                ['name','voice','persona','style','relation','opening'].forEach(id => document.getElementById('edit-'+id).value = '');
            }
            ['persona','style','relation','opening'].forEach(id => updateCount(id));
            document.getElementById('agent-editor').style.display = 'flex';
            setTimeout(() => document.getElementById('agent-editor').classList.add('open'), 10);
            lucide.createIcons();
        }

        function closeAgentEditor() {
            document.getElementById('agent-editor').classList.remove('open');
            setTimeout(() => document.getElementById('agent-editor').style.display = 'none', 300);
        }

        function handleFilePreview(input, type) {
            if(input.files && input.files[0]) {
                const url = URL.createObjectURL(input.files[0]);
                if(type === 'avatar') {
                    tempBlobAvatar = url;
                    const img = document.getElementById('av-preview-img');
                    img.src = url; img.style.display = 'block';
                    document.getElementById('av-plus').style.display = 'none';
                } else {
                    tempBlobBg = url;
                    const isVideo = input.files[0].type.startsWith('video');
                    tempBgType = isVideo ? 'video' : 'img';
                    if(isVideo) {
                        const v = document.getElementById('bg-preview-video');
                        v.src = url; v.style.display = 'block'; v.play();
                        document.getElementById('bg-preview-img').style.display = 'none';
                    } else {
                        const i = document.getElementById('bg-preview-img');
                        i.src = url; i.style.display = 'block';
                        document.getElementById('bg-preview-video').style.display = 'none';
                    }
                    document.getElementById('bg-plus').style.display = 'none';
                }
            }
        }

        function saveAgent() {
            const name = document.getElementById('edit-name').value;
            if(!name) { alert('è¯·å¡«å†™åå­—'); return; }
            const initSlots = () => ({ 
                0: {history:[], memory:"", userPersona:"", tweets:[], searchHistory:[]}, 
                1: {history:[], memory:"", userPersona:"", tweets:[], searchHistory:[]}, 
                2: {history:[], memory:"", userPersona:"", tweets:[], searchHistory:[]} 
            });
            const data = {
                name: name,
                gender: document.getElementById('edit-gender').value,
                voiceId: document.getElementById('edit-voice').value,
                persona: document.getElementById('edit-persona').value,
                style: document.getElementById('edit-style').value,
                relation: document.getElementById('edit-relation').value,
                opening: document.getElementById('edit-opening').value,
                avatar: tempBlobAvatar || 'https://api.dicebear.com/7.x/bottts/svg?seed='+name,
                bgSrc: tempBlobBg,
                bgType: tempBgType,
                isPinned: false, 
                slots: (editingAgentIdx > -1 && agents[editingAgentIdx].slots) ? agents[editingAgentIdx].slots : initSlots()
            };
            if(editingAgentIdx > -1) {
                data.isPinned = agents[editingAgentIdx].isPinned;
                agents[editingAgentIdx] = data;
                if(currentAgentIdx === editingAgentIdx) openChat(currentAgentIdx, true); 
            } else {
                agents.push(data);
            }
            renderAgents();
            closeAgentEditor();
        }

        /* --- Chat Logic --- */
        function openChat(idx, keepHistory = false) {
            currentAgentIdx = idx;
            const agent = agents[idx];
            
            const bgCon = document.getElementById('chat-bg-container');
            bgCon.innerHTML = '';
            if(agent.bgSrc) {
                if(agent.bgType === 'video') {
                    const v = document.createElement('video');
                    v.src = agent.bgSrc; v.autoplay = true; v.loop = true; v.muted = true;
                    v.style.width = '100%'; v.style.height = '100%'; v.style.objectFit = 'cover';
                    bgCon.appendChild(v);
                } else {
                    bgCon.style.backgroundImage = `url(${agent.bgSrc})`;
                    // Force background settings again in JS for safety
                    bgCon.style.backgroundSize = 'cover';
                    bgCon.style.backgroundPosition = 'center';
                }
            } else {
                bgCon.style.background = '#eee';
                bgCon.style.backgroundImage = 'none';
            }

            document.getElementById('chat-title').innerText = agent.name;
            if(!agent.slots) agent.slots = { 
                0: {history:[], memory:"", userPersona:"", tweets:[], searchHistory:[]}, 
                1: {history:[], memory:"", userPersona:"", tweets:[], searchHistory:[]}, 
                2: {history:[], memory:"", userPersona:"", tweets:[], searchHistory:[]} 
            };
            
            loadSlotData(currentSlot);

            // Twitter Init
            document.getElementById('tw-avatar').src = agent.avatar;
            document.getElementById('tw-name').innerText = agent.name;
            document.getElementById('tw-handle').innerText = "@" + agent.name.toLowerCase().replace(/\s+/g, '_');
            document.getElementById('tw-bio').innerText = agent.persona ? agent.persona.substring(0, 50) + "..." : "Based in Virtual World.";
            renderTweets(); 
            renderSearchHistory(); // Browser Init
            
            // Clear previous summon context on entry
            tempSummonContext = "";
            document.getElementById('summon-output').innerHTML = '<span style="opacity:0.5; font-style:italic;">(ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¬å”¤é…è§’/æ—ç™½...)</span>';

            // Clear Taobao UI for fresh session (no memory saved)
            document.getElementById('tb-list-render').innerHTML = '<div style="padding:40px; text-align:center; color:#999; font-size:0.9rem;">æš‚æ— æ–°è®¢å•</div>';
            // Reset Taobao Badge for new chat entry
            document.getElementById('tb-badge').innerText = '0';
            document.getElementById('tb-badge').style.display = 'none';

            document.getElementById('chat-room').style.display = 'flex';
            setTimeout(()=>document.getElementById('chat-room').classList.add('open'),10);
            
            // Default open Summon tab if drawer was closed
            jumpMoreTab('summon'); 
            
            lucide.createIcons();
        }

        function loadSlotData(slotId) {
            currentSlot = slotId;
            const agent = agents[currentAgentIdx];
            const slotData = agent.slots[slotId];
            if(!slotData.tweets) slotData.tweets = [];
            if(!slotData.searchHistory) slotData.searchHistory = [];

            document.querySelectorAll('.save-slot').forEach(el => el.classList.remove('active'));
            document.getElementById('slot-'+slotId).classList.add('active');
            [0,1,2].forEach(i => {
                if(agent.slots[i].history.length > 0 || agent.slots[i].memory) 
                    document.getElementById('slot-'+i).classList.add('has-data');
                else document.getElementById('slot-'+i).classList.remove('has-data');
            });

            if(slotData.history.length === 0 && agent.opening) {
                slotData.history.push({role: 'bot', content: agent.opening, memSnap: ""});
            }

            document.getElementById('event-book').value = slotData.memory;
            document.getElementById('c-event').innerText = slotData.memory.length;
            document.getElementById('user-persona').value = slotData.userPersona;
            document.getElementById('c-userp').innerText = slotData.userPersona.length;

            renderChat();
            renderTweets();
            renderSearchHistory();
        }

        function switchSlot(id) {
            if(currentSlot === id) return;
            loadSlotData(id);
        }

        function renderChat() {
            const box = document.getElementById('chat-box');
            box.innerHTML = '';
            const history = agents[currentAgentIdx].slots[currentSlot].history;
            const userAvatarSrc = document.getElementById('my-avatar').src;
            const agent = agents[currentAgentIdx];

            history.forEach((msg, index) => {
                const isBot = msg.role === 'bot';
                const row = document.createElement('div');
                row.className = `chat-row ${isBot ? 'bot' : 'user'}`;
                let contentHtml = `<div class="bubble ${isBot ? 'bubble-bot' : 'bubble-user'}">${msg.content}</div>`;
                let toolbarHtml = '';
                if(isBot) {
                    toolbarHtml = `
                    <div class="msg-actions">
                        <div class="action-btn" onclick="doRespeak(${index})">é‡è¯´</div>
                        <div class="action-btn" onclick="playTTS('${msg.content.replace(/'/g, "\\'")}', '${agent.voiceId}')">è¯­éŸ³</div>
                        <div class="action-btn" onclick="doRewrite(${index})">æ”¹å†™</div>
                    </div>`;
                } else {
                    toolbarHtml = `
                    <div class="msg-actions">
                        <div class="action-btn" onclick="doWithdraw(${index})">æ’¤å›</div>
                    </div>`;
                }
                row.innerHTML = `<div class="chat-row-inner">${isBot ? `<img src="${agent.avatar}" class="chat-avatar">` : ''}${!isBot ? contentHtml : ''}${isBot ? contentHtml : ''}${!isBot ? `<img src="${userAvatarSrc}" class="chat-avatar">` : ''}</div>${toolbarHtml}`;
                box.appendChild(row);
            });
            box.scrollTop = box.scrollHeight;
            lucide.createIcons();
        }

        function editCurrentAgent() { openAgentEditor(currentAgentIdx); }
        function closeChat() { document.getElementById('chat-room').classList.remove('open'); setTimeout(()=>document.getElementById('chat-room').style.display = 'none',300); }
        function updateMemoryData(txt) { agents[currentAgentIdx].slots[currentSlot].memory = txt; document.getElementById('c-event').innerText = txt.length; }
        function updateUserPersona(txt) { agents[currentAgentIdx].slots[currentSlot].userPersona = txt; document.getElementById('c-userp').innerText = txt.length; }

        // ä¿®æ”¹ï¼šäº‹ä»¶è‡ªåŠ¨è®°å½•æ”¹ä¸ºåƒå†™å°ç»“ä¸€æ ·ï¼Œæœ‰è¯¦æœ‰ç•¥ï¼Œè€Œä¸æ˜¯æ¯å¥éƒ½è®°å½•
        async function autoSummarizeMemory() {
            const agent = agents[currentAgentIdx];
            const s = agent.slots[currentSlot];
            
            // å¦‚æœå¯¹è¯å†å²å°‘äº3æ¡ï¼Œä¸è¿›è¡Œæ€»ç»“
            if (s.history.length < 3) {
                return;
            }
            
            // è·å–æœ€è¿‘çš„5æ¡å¯¹è¯è®°å½•
            const recentHistory = s.history.slice(-5);
            
            // æ„å»ºæ€»ç»“æç¤ºè¯
            const summaryPrompt = `è¯·å¯¹ä»¥ä¸‹å¯¹è¯è¿›è¡Œç®€è¦æ€»ç»“ï¼Œçªå‡ºé‡ç‚¹äº‹ä»¶å’Œæƒ…æ„Ÿå˜åŒ–ï¼Œæœ‰è¯¦æœ‰ç•¥ï¼Œä¸è¦è®°å½•æ¯å¥è¯ï¼š
            
            å¯¹è¯è®°å½•ï¼š
            ${recentHistory.map(msg => `${msg.role === 'user' ? 'ç”¨æˆ·' : agent.name}: ${msg.content}`).join('\n')}
            
            è¯·ç”¨ä¸­æ–‡å†™ä¸€ä¸ªç®€æ´çš„æ€»ç»“ï¼Œçªå‡ºé‡è¦äº‹ä»¶å’Œæƒ…æ„Ÿå˜åŒ–ï¼š`;

            let url = document.getElementById('api-url').value;
            const key = document.getElementById('api-key').value;
            const model = document.getElementById('model-id').value;

            if(!model) return;

            let base = cleanBaseUrl(url);
            let target = base.endsWith('/v1') ? base + '/chat/completions' : base + '/v1/chat/completions';

            try {
                const res = await fetch(target, {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${key}` },
                    body: JSON.stringify({ 
                        model: model, 
                        messages: [{role:'user', content: summaryPrompt}],
                        max_tokens: 300
                    })
                });
                
                if(!res.ok) throw new Error(res.status);
                const data = await res.json();
                const summary = data.choices[0].message.content;
                
                // å°†æ€»ç»“æ·»åŠ åˆ°ç°æœ‰è®°å¿†çš„æœ«å°¾ï¼Œç”¨æ¢è¡Œåˆ†éš”
                const currentMemory = s.memory || "";
                const newMemory = currentMemory ? `${currentMemory}\n\n${summary}` : summary;
                
                // é™åˆ¶è®°å¿†é•¿åº¦ï¼Œé¿å…è¿‡é•¿
                if (newMemory.length > 3000) {
                    // å¦‚æœè¶…è¿‡3000å­—ç¬¦ï¼Œåªä¿ç•™æœ€è¿‘çš„æ€»ç»“
                    s.memory = summary;
                } else {
                    s.memory = newMemory;
                }
                
                // æ›´æ–°äº‹ä»¶ç°¿æ˜¾ç¤º
                document.getElementById('event-book').value = s.memory;
                document.getElementById('c-event').innerText = s.memory.length;
                
            } catch(e) {
                console.error("è‡ªåŠ¨æ€»ç»“å¤±è´¥:", e);
            }
        }

        function doWithdraw(index) {
            if(!confirm("ç¡®å®šæ’¤å›ï¼Ÿ")) return;
            const s = agents[currentAgentIdx].slots[currentSlot];
            if(index > 0 && s.history[index-1].memSnap) s.memory = s.history[index-1].memSnap;
            else if (index === 0) s.memory = "";
            s.history = s.history.slice(0, index);
            renderChat();
            document.getElementById('event-book').value = s.memory;
        }
        function doRewrite(index) {
            const newText = prompt("ä¿®æ”¹å›å¤å†…å®¹ï¼š", agents[currentAgentIdx].slots[currentSlot].history[index].content);
            if(newText) { agents[currentAgentIdx].slots[currentSlot].history[index].content = newText; renderChat(); }
        }
        function doRespeak(index) {
            const s = agents[currentAgentIdx].slots[currentSlot];
            if(index === 0 || s.history[index-1].role !== 'user') return;
            const lastUserMsg = s.history[index-1].content;
            s.history = s.history.slice(0, index);
            renderChat();
            callLLM(lastUserMsg); 
        }

        async function sendMsg() {
            const input = document.getElementById('msg-in');
            const txt = input.value.trim();
            if(!txt) return;
            const s = agents[currentAgentIdx].slots[currentSlot];
            const currentMemSnap = s.memory; 
            s.history.push({ role: 'user', content: txt, memSnap: currentMemSnap });
            input.value = '';
            renderChat();
            await callLLM(txt);
        }

        async function callLLM(userTxt) {
            const agent = agents[currentAgentIdx];
            const s = agent.slots[currentSlot];
            const box = document.getElementById('chat-box');
            let url = document.getElementById('api-url').value;
            const key = document.getElementById('api-key').value;
            const model = document.getElementById('model-id').value;

            if(!model) { s.history.push({role:'bot', content:'è¯·å…ˆè®¾ç½®æ¨¡å‹ ID'}); renderChat(); return; }

            let sys = `ä½ æ‰®æ¼”${agent.name}ã€‚
            [è§’è‰²è®¾å®š]: ${agent.persona}
            [å¯¹è¯é£æ ¼]: ${agent.style}
            [äººç‰©å…³ç³»]: ${agent.relation}
            [ç”¨æˆ·è®¾å®š]: ${s.userPersona}
            [å½“å‰äº‹ä»¶è®°å¿†]: ${s.memory}`;

            if(tempSummonContext) {
                sys += `\n\n[â—ï¸å½“å‰åœºæ™¯å‘ç”Ÿçš„é¢å¤–äº‹ä»¶/è”åŠ¨äººç‰©åŠ¨ä½œ]: ${tempSummonContext}\n(è¯·æ ¹æ®æ­¤äº‹ä»¶è°ƒæ•´ä½ çš„å›å¤ï¼Œä¸åœºæ™¯äº’åŠ¨)`;
            }

            let contextMsgs = s.history.slice(-10).map(m => ({ role: m.role, content: m.content }));
            let messages = [{role:'system', content: sys}, ...contextMsgs];
            let base = cleanBaseUrl(url);
            let target = base.endsWith('/v1') ? base + '/chat/completions' : base + '/v1/chat/completions';

            const loadId = 'ld-' + Date.now();
            const loadRow = document.createElement('div');
            loadRow.id = loadId; loadRow.className = 'chat-row bot';
            loadRow.innerHTML = `<div class="chat-row-inner"><img src="${agent.avatar}" class="chat-avatar"><div class="bubble bubble-bot">...</div></div>`;
            box.appendChild(loadRow);
            box.scrollTop = box.scrollHeight;
            
            try {
                const res = await fetch(target, {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${key}` },
                    body: JSON.stringify({ model: model, messages: messages })
                });
                if(!res.ok) throw new Error(res.status);
                const data = await res.json();
                document.getElementById(loadId).remove();
                const reply = data.choices[0].message.content;
                s.history.push({ role: 'bot', content: reply, memSnap: s.memory });
                renderChat();
                if(agent.voiceId) playTTS(reply, agent.voiceId);
                
                // å¢åŠ è®¡æ•°å™¨ï¼Œæ¯5è½®å¯¹è¯è‡ªåŠ¨æ€»ç»“ä¸€æ¬¡
                autoSummaryCounter++;
                if (autoSummaryCounter >= SUMMARY_INTERVAL) {
                    autoSummaryCounter = 0;
                    // å¼‚æ­¥è¿›è¡Œè‡ªåŠ¨æ€»ç»“
                    setTimeout(() => autoSummarizeMemory(), 1000);
                }
                
            } catch(e) {
                document.getElementById(loadId).remove();
                alert("è¯·æ±‚å¤±è´¥: " + e.message);
            }
        }

        async function playTTS(text, vid) {
            const gid = document.getElementById('mm-group').value;
            const key = document.getElementById('mm-key').value;
            if(!gid || !key) return;
            try {
                const res = await fetch(`https://api.minimax.chat/v1/text_to_speech?GroupId=${gid}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ voice_setting: { voice_id: vid, speed: 1, vol: 1, pitch: 0 }, audio_setting: { sample_rate: 32000, bitrate: 128000, format: "mp3", channel: 1 }, text: text, model: "speech-01" })
                });
                const blob = await res.blob();
                new Audio(URL.createObjectURL(blob)).play();
            } catch(e) {}
        }

        /* --- Twitter Logic --- */
        function previewImage(input, targetId) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) { document.getElementById(targetId).src = e.target.result; }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function toggleLike(el) {
            const icon = el.querySelector('.tw-like-icon');
            const count = el.querySelector('.tw-like-count');
            if(icon.classList.contains('like-anim')) {
                icon.classList.remove('like-anim'); icon.style.fill = 'none'; icon.style.color = 'currentColor';
                count.innerText = parseInt(count.innerText) - 1;
            } else {
                icon.classList.add('like-anim'); count.innerText = parseInt(count.innerText) + 1;
            }
        }

        function renderTweets() {
            const list = document.getElementById('tweet-list-render');
            list.innerHTML = '';
            const tweets = agents[currentAgentIdx].slots[currentSlot].tweets || [];
            
            tweets.forEach((tw, idx) => {
                const div = document.createElement('div');
                div.className = 'tweet-card';
                
                let commentsHtml = '';
                tw.comments.forEach(c => {
                    const hue = Math.floor(Math.random()*360);
                    commentsHtml += `
                    <div class="comment-item">
                        <div class="w-8 h-8 rounded-full bg-gray-700 flex-shrink-0" style="background-color:hsl(${hue}, 60%, 40%)"></div>
                        <div>
                            <div class="flex items-center gap-2"><span class="font-bold text-sm text-gray-300">${c.user}</span></div>
                            <p class="text-sm text-gray-400 mt-0.5">${c.text}</p>
                        </div>
                    </div>`;
                });

                div.innerHTML = `
                <div class="flex gap-3">
                    <div class="w-10 h-10 rounded-full overflow-hidden bg-gray-800 shrink-0">
                        <img src="${agents[currentAgentIdx].avatar}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-1">
                            <span class="font-bold text-white text-[15px]">${agents[currentAgentIdx].name}</span>
                            <span class="text-gray-500 text-sm">@${agents[currentAgentIdx].name} Â· ${tw.time}</span>
                        </div>
                        <p class="mt-1 text-[15px] leading-relaxed text-gray-200">${tw.content}</p>
                        <div class="mt-3 aspect-video w-full bg-[#16181c] rounded-2xl border border-gray-800 flex flex-col items-center justify-center text-gray-500 p-4 text-center">
                            <i data-lucide="image" class="w-8 h-8 mb-2 opacity-50"></i>
                            <p class="text-xs text-gray-400 italic">ğŸ“¸ ${tw.image_desc}</p>
                        </div>
                        <div class="flex justify-between mt-3 text-gray-500 max-w-md pr-4">
                            <div class="flex items-center gap-2 group"><i data-lucide="message-square" class="w-4 h-4"></i><span class="text-xs">${tw.comments.length}</span></div>
                            <div class="flex items-center gap-2 group"><i data-lucide="repeat" class="w-4 h-4"></i><span class="text-xs">${tw.rts}</span></div>
                            <div class="flex items-center gap-2 group cursor-pointer" onclick="toggleLike(this.parentElement.parentElement)">
                                <i data-lucide="heart" class="w-4 h-4 tw-like-icon"></i><span class="text-xs tw-like-count">${tw.likes}</span>
                            </div>
                            <div class="flex items-center gap-2 group"><i data-lucide="bar-chart-2" class="w-4 h-4"></i><span class="text-xs">${tw.views}</span></div>
                        </div>
                    </div>
                </div>
                <div class="mt-2 pl-12 border-t border-gray-800 pt-2">${commentsHtml}</div>
                `;
                list.appendChild(div);
            });
            lucide.createIcons();
        }

        async function generateSocialPost() {
            const agent = agents[currentAgentIdx];
            const s = agent.slots[currentSlot];
            const btn = document.querySelector('#mp-tweet .float-tweet-btn');
            btn.style.opacity = '0.5';
            
            let url = document.getElementById('api-url').value;
            const key = document.getElementById('api-key').value;
            const model = document.getElementById('model-id').value;

            const prompt = `User: Generate a social media post (Twitter style) based on character: ${agent.name}, persona: ${agent.persona}, and recent chat memory. 
            Return JSON format: { "content": "post text", "image_desc": "photo description", "comments": [{"user":"fan","text":"comment"}] } (Max 3 comments)`;

            let base = cleanBaseUrl(url);
            let target = base.endsWith('/v1') ? base + '/chat/completions' : base + '/v1/chat/completions';
            
            try {
                const res = await fetch(target, {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${key}` },
                    body: JSON.stringify({ model: model, messages: [{role:'user', content: prompt}] })
                });
                const data = await res.json();
                let result = data.choices[0].message.content;
                result = result.replace(/```json/g, '').replace(/```/g, '');
                const json = JSON.parse(result);
                
                json.likes = Math.floor(Math.random() * 5000) + 100;
                json.rts = Math.floor(json.likes * 0.2);
                json.views = (json.likes * 15 / 1000).toFixed(1) + 'k';
                json.time = 'Just now';
                
                if(!s.tweets) s.tweets = [];
                s.tweets.unshift(json);
                if(s.tweets.length > 10) s.tweets.pop();
                
                renderTweets();

            } catch(e) { alert("ç”Ÿæˆå¤±è´¥: " + e.message); }
            btn.style.opacity = '1';
        }

        /* --- Google / Search History Logic --- */
        function renderSearchHistory() {
            const list = document.getElementById('browser-list-render');
            list.innerHTML = '';
            const sh = agents[currentAgentIdx].slots[currentSlot].searchHistory || [];

            if(sh.length === 0) {
                list.innerHTML = `<div style="padding:40px; text-align:center; color:#5f6368; font-size:0.9rem;">æš‚æ— æœç´¢è®°å½•</div>`;
                return;
            }

            const iconMap = {
                search: { icon: 'search', bg: 'bg-blue-dark', text: 'text-blue-glow', meta: `å·²æœç´¢ Â· Google.com` },
                map: { icon: 'map-pin', bg: 'bg-purple-dark', text: 'text-purple-glow', meta: 'åœ¨åœ°å›¾ä¸­æŸ¥çœ‹è¿‡' },
                shop: { icon: 'shopping-cart', bg: 'bg-green-dark', text: 'text-green-glow', meta: 'å·²è®¿é—®ï¼šshopping.google.com' }
            };

            sh.forEach(item => {
                const conf = iconMap[item.type] || iconMap.search;
                const row = document.createElement('div');
                row.className = 'search-item';
                row.innerHTML = `
                    <div class="icon-circle ${conf.bg}">
                        <i data-lucide="${conf.icon}" class="w-4 h-4 ${conf.text}"></i>
                    </div>
                    <div class="search-content">
                        <div class="search-title">
                            <span>${item.query}</span>
                            <span class="search-time">${item.time}</span>
                        </div>
                        <div class="search-meta">${conf.meta}</div>
                        <div class="ai-thought-box">
                            <span>Taçš„ç¢ç¢å¿µï¼š${item.thought}</span>
                        </div>
                    </div>
                    <div style="color:#9aa0a6; cursor:pointer;" onclick="this.parentElement.remove()"><i data-lucide="x" class="w-4 h-4"></i></div>
                `;
                list.appendChild(row);
            });
            lucide.createIcons();
        }

        async function generateSearchHistory() {
            const agent = agents[currentAgentIdx];
            const s = agent.slots[currentSlot];
            const btn = document.querySelector('#mp-google .float-tweet-btn');
            btn.style.opacity = '0.5';

            let url = document.getElementById('api-url').value;
            const key = document.getElementById('api-key').value;
            const model = document.getElementById('model-id').value;

            const prompt = `User: Generate ONE fake browser search query based on character: ${agent.name}, persona: ${agent.persona}, and recent chat memory. 
            Randomly choose type: "search", "map", or "shop".
            Return JSON format: { "type": "search/map/shop", "query": "search text", "thought": "short witty inner monologue" }`;

            let base = cleanBaseUrl(url);
            let target = base.endsWith('/v1') ? base + '/chat/completions' : base + '/v1/chat/completions';

            try {
                const res = await fetch(target, {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${key}` },
                    body: JSON.stringify({
                        model: model,
                        messages: [{role:'user', content: prompt}],
                        response_format: { type: "json_object" } 
                    })
                });
                const data = await res.json();
                let result = data.choices[0].message.content;
                result = result.replace(/```json/g, '').replace(/```/g, '');
                const json = JSON.parse(result);

                const now = new Date();
                json.time = `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;

                if(!s.searchHistory) s.searchHistory = [];
                s.searchHistory.unshift(json); 
                if(s.searchHistory.length > 10) s.searchHistory.pop();
                renderSearchHistory();

            } catch(e) { alert("ç”Ÿæˆæœç´¢è®°å½•å¤±è´¥: " + e.message); }
            btn.style.opacity = '1';
        }

        /* --- Summon Logic --- */
        async function generateSummon() {
            const agent = agents[currentAgentIdx];
            const s = agent.slots[currentSlot];
            const btn = document.querySelector('#mp-summon .float-tweet-btn');
            btn.style.opacity = '0.5';

            let url = document.getElementById('api-url').value;
            const key = document.getElementById('api-key').value;
            const model = document.getElementById('model-id').value;

            const prompt = `User: Based on the "Linked Characters" defined as: [${agent.relation}], and the current chat memory: [${s.memory}], generate a short dialogue or action scene involving THESE linked characters. 
            The main character (${agent.name}) might be mentioned but is NOT the speaker. 
            Output ONLY the scene text (e.g. "Butler: The master is looking for you."). Keep it short and impactful.`;

            let base = cleanBaseUrl(url);
            let target = base.endsWith('/v1') ? base + '/chat/completions' : base + '/v1/chat/completions';

            try {
                const res = await fetch(target, {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${key}` },
                    body: JSON.stringify({
                        model: model,
                        messages: [{role:'user', content: prompt}]
                    })
                });
                const data = await res.json();
                let result = data.choices[0].message.content;
                
                tempSummonContext = result; // Store for next LLM turn
                document.getElementById('summon-output').innerText = result;

            } catch(e) { alert("å¬å”¤å¤±è´¥: " + e.message); }
            btn.style.opacity = '1';
        }

        /* --- Taobao Logic --- */
        async function generateTaobaoOrder() {
            const agent = agents[currentAgentIdx];
            const btn = document.querySelector('#mp-taobao .float-tweet-btn');
            btn.style.opacity = '0.5';

            let url = document.getElementById('api-url').value;
            const key = document.getElementById('api-key').value;
            const model = document.getElementById('model-id').value;

            const prompt = `User: Generate ONE fake Taobao shopping order based on character: ${agent.name}, persona: ${agent.persona}, and recent chat memory.
            Return JSON format: { "itemName": "Creative product name", "price": "e.g. 299.00", "type": "shirt/gift/food/gadget", "comment": "Ta's secret thought about buying this" }`;

            let base = cleanBaseUrl(url);
            let target = base.endsWith('/v1') ? base + '/chat/completions' : base + '/v1/chat/completions';

            try {
                const res = await fetch(target, {
                    method: 'POST',
                    headers: { 'Content-Type':'application/json', 'Authorization':`Bearer ${key}` },
                    body: JSON.stringify({
                        model: model,
                        messages: [{role:'user', content: prompt}],
                        response_format: { type: "json_object" } 
                    })
                });
                const data = await res.json();
                let result = data.choices[0].message.content;
                result = result.replace(/```json/g, '').replace(/```/g, '');
                const json = JSON.parse(result);

                const list = document.getElementById('tb-list-render');
                // Remove placeholder if exists
                if(list.innerText.includes('æš‚æ— æ–°è®¢å•')) list.innerHTML = '';

                // Increment Badge (Dynamic Logic)
                const badge = document.getElementById('tb-badge');
                let count = parseInt(badge.innerText) || 0;
                count++;
                badge.innerText = count;
                badge.style.display = 'block';

                // Icon mapping
                let icon = 'package';
                if(json.type.includes('shirt') || json.type.includes('cloth')) icon = 'shirt';
                else if(json.type.includes('food')) icon = 'utensils';
                else if(json.type.includes('gift')) icon = 'gift';
                else if(json.type.includes('gadget')) icon = 'gamepad-2';

                const html = `
                <div class="order-card p-4 shadow-sm border-2 border-orange-100 animate-pulse">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-2 font-bold text-sm">
                            <i data-lucide="shopping-bag" class="w-4 h-4 text-gray-400"></i>
                            å®˜æ–¹æ——èˆ°åº— >
                        </div>
                        <span class="status-tag">ç­‰å¾…å‘è´§</span>
                    </div>
                    <div class="flex gap-3">
                        <div class="w-20 h-20 bg-gray-100 rounded-lg flex-shrink-0 flex items-center justify-center border border-gray-100">
                            <i data-lucide="${icon}" class="w-8 h-8 text-gray-300"></i>
                        </div>
                        <div class="flex-1">
                            <h2 class="text-sm line-clamp-2 font-bold">${json.itemName}</h2>
                            <p class="text-xs text-gray-400 mt-1">7å¤©æ— ç†ç”±é€€æ¢</p>
                            <div class="flex justify-between items-end mt-2">
                                <span class="font-bold">Â¥ ${json.price}</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-t border-dashed border-gray-200 flex items-start gap-2">
                       <span class="text-xs bg-orange-100 text-tb-orange px-1.5 py-0.5 rounded">Taçš„ç¢ç¢å¿µ</span>
                       <p class="text-xs text-gray-500 italic">"${json.comment}"</p>
                    </div>
                </div>
                `;
                list.insertAdjacentHTML('afterbegin', html);
                lucide.createIcons();

            } catch(e) { alert("ç”Ÿæˆè®¢å•å¤±è´¥: " + e.message); }
            btn.style.opacity = '1';
        }

        function toggleMoreDrawer(forceOpen) {
            const p = document.getElementById('more-panel');
            if(forceOpen === true) p.classList.add('open');
            else if(forceOpen === false) p.classList.remove('open');
            else p.classList.toggle('open');
            lucide.createIcons();
        }

        function saveGlobalSettings() {
            const s = localStorage;
            s.setItem('m6_name', document.getElementById('my-name').value);
            s.setItem('m6_url', document.getElementById('api-url').value);
            s.setItem('m6_key', document.getElementById('api-key').value);
            s.setItem('m6_model', document.getElementById('model-id').value);
            s.setItem('m6_mmg', document.getElementById('mm-group').value);
            s.setItem('m6_mmk', document.getElementById('mm-key').value);
            const btn = document.querySelector('.btn-save');
            btn.innerText = "å·²ä¿å­˜"; btn.style.background = "#27ae60";
            setTimeout(()=>{ btn.innerText="ä¿å­˜è®¾ç½®"; btn.style.background="#2c3e50"; },1500);
        }
        
        function loadSettings() {
            const s = localStorage;
            if(s.getItem('m6_name')) document.getElementById('my-name').value = s.getItem('m6_name');
            if(s.getItem('m6_url')) document.getElementById('api-url').value = s.getItem('m6_url');
            if(s.getItem('m6_key')) document.getElementById('api-key').value = s.getItem('m6_key');
            if(s.getItem('m6_model')) document.getElementById('model-id').value = s.getItem('m6_model');
            if(s.getItem('m6_mmg')) document.getElementById('mm-group').value = s.getItem('m6_mmg');
            if(s.getItem('m6_mmk')) document.getElementById('mm-key').value = s.getItem('m6_mmk');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç¾åŒ–ä¸­å¿ƒ
        window.addEventListener('DOMContentLoaded', function() {
            // å¦‚æœç”¨æˆ·å·²ç»è¿›å…¥åº”ç”¨ï¼Œæ¸²æŸ“ç¾åŒ–ä¸­å¿ƒ
            if (document.getElementById('cover-page').style.display === 'none') {
                renderMall();
            }
        });
    </script>
</body>
</html>
