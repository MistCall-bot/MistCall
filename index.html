<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MistCall</title>
    <!-- 引入 Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* =================视觉风格保持一致================= */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; }
        body, html { width: 100%; height: 100%; overflow: hidden; background-color: #f0f2f5; }

        /* 开机封面 */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; transition: opacity 0.8s ease; cursor: pointer;
        }
        .splash-title {
            font-family: "Didot", "Bodoni MT", serif; font-size: 3.8rem; font-weight: bold; font-style: italic;
            background: linear-gradient(110deg, #8e9eab 20%, #ffffff 45%, #a1c4fd 50%, #fbc2eb 55%, #8e9eab 80%);
            background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: shineRight 4.5s linear infinite;
        }
        .splash-slogan { font-family: "Snell Roundhand", cursive; margin-top: 15px; font-size: 1.2rem; color: rgba(142, 158, 171, 0.5); }
        .tap-hint { position: absolute; bottom: 60px; font-size: 0.9rem; color: #7a8b99; animation: breathe 3s ease-in-out infinite; }

        @keyframes shineRight { 0% { background-position: -100% center; } 100% { background-position: 200% center; } }
        @keyframes breathe { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }

        /* 登录/注册界面 */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(20px);
            z-index: 9000; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 40px;
        }
        .auth-container { width: 100%; max-width: 320px; }
        .auth-title { font-size: 1.5rem; margin-bottom: 30px; text-align: center; color: #333; font-weight: 300; }
        .input-group { margin-bottom: 15px; }
        .input-group input { width: 100%; padding: 14px 15px; border-radius: 12px; border: 1px solid #ddd; outline: none; font-size: 16px; }
        .auth-btn { width: 100%; padding: 14px; border-radius: 12px; border: none; background: #333; color: white; font-size: 1rem; cursor: pointer; margin-top: 10px; }
        .switch-mode { margin-top: 20px; font-size: 0.85rem; color: #666; text-align: center; cursor: pointer; text-decoration: underline; }

        /* 主界面 */
        #main-app { opacity: 0; display: none; transition: opacity 1s ease; height: 100%; flex-direction: column; }
        .header { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid rgba(0,0,0,0.05); background: rgba(255,255,255,0.6); backdrop-filter: blur(10px); }
        .header-title { font-size: 1.1rem; font-weight: 600; color: #333; }
        .content { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .card { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); }
        .card h3 { font-size: 0.9rem; margin-bottom: 10px; color: #999; text-transform: uppercase; letter-spacing: 1px; }
        .balance-num { font-size: 2.5rem; font-weight: bold; color: #333; margin-bottom: 5px; }
        .balance-unit { font-size: 1rem; color: #999; margin-left: 5px; font-weight: normal; }
        
        .recharge-box { display: flex; flex-direction: column; gap: 12px; margin-top: 5px; }
        .recharge-input { width: 100%; padding: 14px; border: 1px solid #eee; border-radius: 12px; outline: none; background: #f9f9f9; font-size: 1rem; }
        .recharge-btn { width: 100%; padding: 14px; background: #5B86E5; color: #fff; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; }

        .nav-bar { height: 75px; background: #fff; border-top: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-around; align-items: center; padding-bottom: 15px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #bbb; font-size: 0.75rem; }
        .nav-item.active { color: #5B86E5; }
        .nav-icon { width: 22px; height: 22px; background: #eee; border-radius: 6px; }
        .nav-item.active .nav-icon { background: #5B86E5; }

        .hidden { opacity: 0; pointer-events: none; }
        #auth-msg, #recharge-msg { font-size: 0.8rem; margin-top: 10px; text-align: center; min-height: 1em; }
    </style>
</head>
<body>

    <!-- 1. 开机封面 -->
    <div id="splash-screen" onclick="checkAuth()">
        <div class="splash-title">MistCall</div>
        <div class="splash-slogan">You are the only color in my world.</div>
        <div class="tap-hint">点击屏幕开始</div>
    </div>

    <!-- 2. 登录/注册界面 -->
    <div id="auth-screen">
        <div class="auth-container">
            <div class="auth-title" id="auth-ui-title">登录 MistCall</div>
            <div class="input-group">
                <input type="email" id="email" placeholder="电子邮箱">
            </div>
            <div class="input-group">
                <input type="password" id="password" placeholder="密码">
            </div>
            <button class="auth-btn" id="auth-main-btn" onclick="handleAuth()">登 录</button>
            <div class="switch-mode" id="auth-switch" onclick="toggleAuthMode()">没有账号？去注册</div>
            <div id="auth-msg"></div>
        </div>
    </div>

    <!-- 3. 主应用界面 -->
    <div id="main-app">
        <header class="header">
            <div class="header-title">我的钱包</div>
            <div onclick="signOut()" style="font-size: 0.8rem; color: #999; cursor: pointer;">退出登录</div> 
        </header>

        <div class="content">
            <!-- 余额显示 -->
            <div class="card">
                <h3>当前余额</h3>
                <div class="balance-num" id="user-balance">0.00<span class="balance-unit">Mist币</span></div>
                <div style="font-size: 0.8rem; color: #bbb;">钻石余额: <span id="user-diamond">0.00</span></div>
            </div>

            <!-- 卡密充值 -->
            <div class="card">
                <h3>卡密兑换</h3>
                <div class="recharge-box">
                    <input type="text" id="cdkey" class="recharge-input" placeholder="输入 12 位兑换码">
                    <button class="recharge-btn" onclick="handleRedeem()">立即兑换</button>
                </div>
                <div id="recharge-msg"></div>
            </div>

            <!-- 提示信息 -->
            <div style="padding: 10px; color: #999; font-size: 0.8rem; line-height: 1.6;">
                * 卡密可通过爱发电或官方渠道获取。<br>
                * Mist 币用于解锁智能体，解锁后永久有效。
            </div>
        </div>

        <nav class="nav-bar">
            <div class="nav-item active">
                <div class="nav-icon"></div>
                <span>钱包</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon"></div>
                <span>智能体</span>
            </div>
            <div class="nav-item">
                <div class="nav-icon"></div>
                <span>设置</span>
            </div>
        </nav>
    </div>

    <script>
        // --- Supabase 配置 (已根据你的信息填入) ---
        const SUPABASE_URL = 'https://cbxtlwjpbmuniexcuzrp.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Bsfqqe6VtGO_yFth6JyDLw_-SA4V3EM';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let isRegisterMode = false;

        // 1. 检查登录状态
        async function checkAuth() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            const splash = document.getElementById('splash-screen');
            splash.classList.add('hidden');
            
            setTimeout(() => {
                splash.style.display = 'none';
                if (session) {
                    showApp();
                } else {
                    document.getElementById('auth-screen').style.display = 'flex';
                }
            }, 800);
        }

        // 2. 切换登录/注册 UI
        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            document.getElementById('auth-ui-title').innerText = isRegisterMode ? '注册 MistCall' : '登录 MistCall';
            document.getElementById('auth-main-btn').innerText = isRegisterMode ? '注 册' : '登 录';
            document.getElementById('auth-switch').innerText = isRegisterMode ? '已有账号？去登录' : '没有账号？去注册';
            document.getElementById('auth-msg').innerText = "";
        }

        // 3. 处理登录或注册
        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msgBox = document.getElementById('auth-msg');
            
            if(!email || !password) {
                msgBox.innerText = "请填写完整信息";
                return;
            }

            msgBox.style.color = "#666";
            msgBox.innerText = "正在处理...";

            if (isRegisterMode) {
                const { data, error } = await supabaseClient.auth.signUp({ email, password });
                if (error) {
                    msgBox.style.color = "red";
                    msgBox.innerText = "注册失败: " + error.message;
                } else {
                    msgBox.style.color = "green";
                    msgBox.innerText = "注册成功！请登录";
                    toggleAuthMode();
                }
            } else {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) {
                    msgBox.style.color = "red";
                    msgBox.innerText = "登录失败: " + error.message;
                } else {
                    showApp();
                }
            }
        }

        // 4. 显示主程序
        async function showApp() {
            document.getElementById('auth-screen').style.display = 'none';
            const app = document.getElementById('main-app');
            app.style.display = 'flex';
            setTimeout(() => app.style.opacity = '1', 50);
            
            fetchUserData();
        }

        // 5. 获取用户数据 (对应你 SQL 里的 mist_coins 字段)
        async function fetchUserData() {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) return;

            // 获取 profiles 数据
            let { data, error } = await supabaseClient
                .from('profiles')
                .select('mist_coins, mist_diamond')
                .eq('id', user.id)
                .single();
            
            // 如果 profiles 还没有该用户（新注册），则创建一条
            if (error && error.code === 'PGRST116') {
                const { data: newData } = await supabaseClient
                    .from('profiles')
                    .insert([{ id: user.id, username: user.email.split('@')[0], mist_coins: 0, mist_diamond: 0 }])
                    .select()
                    .single();
                data = newData;
            }

            if (data) {
                document.getElementById('user-balance').innerHTML = `${parseFloat(data.mist_coins).toFixed(2)}<span class="balance-unit">Mist币</span>`;
                document.getElementById('user-diamond').innerText = parseFloat(data.mist_diamond).toFixed(2);
            }
        }

        // 6. 处理卡密充值 (对应你 SQL 里的 redeem_cdk 函数)
        async function handleRedeem() {
            const key = document.getElementById('cdkey').value.trim();
            const msgBox = document.getElementById('recharge-msg');
            
            if (!key) {
                msgBox.innerText = "请输入卡密";
                return;
            }
            
            msgBox.style.color = "#666";
            msgBox.innerText = "核销中...";

            // 调用 SQL 函数 redeem_cdk
            const { data, error } = await supabaseClient.rpc('redeem_cdk', { input_code: key });

            if (error) {
                msgBox.style.color = "red";
                msgBox.innerText = "系统错误: " + error.message;
            } else if (data.success) {
                msgBox.style.color = "green";
                msgBox.innerText = data.message;
                document.getElementById('cdkey').value = "";
                fetchUserData(); // 刷新余额
            } else {
                msgBox.style.color = "red";
                msgBox.innerText = data.message;
            }
        }

        // 7. 退出登录
        async function signOut() {
            await supabaseClient.auth.signOut();
            window.location.reload();
        }
    </script>
</body>
</html>
