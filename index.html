<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MistCall 调试版</title>
    <!-- 换成 jsDelivr 的国内镜像加速地址 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/supabase/2.39.7/supabase.js"></script>
    <style>
        body { margin: 0; background: #1e3c72; color: white; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .hidden { display: none !important; }
        .modal { position: fixed; inset: 0; background: white; color: #333; padding: 20px; z-index: 1000; display: flex; flex-direction: column; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { background: #2a5298; color: white; border: none; padding: 15px; border-radius: 8px; font-size: 18px; width: 100%; cursor: pointer; }
    </style>
</head>
<body>

    <div id="cover" onclick="forceStart()">
        <h1 style="font-size: 50px;">MistCall</h1>
        <p id="status">正在加载插件...</p>
        <p style="font-size: 12px; opacity: 0.5;">(如果点不动，请刷新网页)</p>
    </div>

    <!-- 简易登录窗口 -->
    <div id="auth-box" class="modal hidden">
        <h2>欢迎加入</h2>
        <input type="email" id="email" placeholder="输入邮箱">
        <input type="password" id="pwd" placeholder="输入密码">
        <button onclick="doAuth()">立即进入</button>
        <p id="auth-msg" style="font-size: 12px; color: red;"></p>
        <button style="background:#ccc; margin-top:20px;" onclick="location.reload()">返回封面</button>
    </div>

    <!-- 简易主页 -->
    <div id="main-page" class="modal hidden">
        <h2 style="color:green">登录成功！</h2>
        <div id="user-info" style="padding: 20px; border: 1px solid #eee; margin-top: 20px;">
            正在获取你的云端余额...
        </div>
        <button style="margin-top:20px;" onclick="location.reload()">退出登录</button>
    </div>

    <script>
        const URL = "https://cbxtlwjpbmuniexcuzrp.supabase.co";
        const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNieHRsd2pwYm11bmlleGN1enJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4OTk0NDEsImV4cCI6MjA4NDQ3NTQ0MX0.GllJZ_5dQTgrrhUZ2FmuLuym-A38oWWeIJuIITLiWgU";
        
        let supabase;

        // 1. 检查插件
        const check = setInterval(() => {
            if (window.supabase) {
                clearInterval(check);
                try {
                    supabase = window.supabase.createClient(URL, KEY);
                    document.getElementById('status').innerText = "✅ 连接成功！点我进入";
                } catch(e) {
                    alert("配置有误: " + e.message);
                }
            }
        }, 500);

        // 2. 暴力启动
        function forceStart() {
            // 只要点了，不管联网没，先给个弹窗
            if (!supabase) {
                alert("插件还没加载好，请再等几秒或者检查网络！");
                return;
            }
            document.getElementById('auth-box').classList.remove('hidden');
        }

        // 3. 登录逻辑
        async function doAuth() {
            const email = document.getElementById('email').value;
            const pwd = document.getElementById('pwd').value;
            const msg = document.getElementById('auth-msg');

            if (!email || !pwd) { alert("请填写完整"); return; }
            
            msg.innerText = "正在联网验证，请稍后...";

            try {
                // 尝试注册
                let { data, error } = await supabase.auth.signUp({ email: email, password: pwd });
                
                // 如果报错（可能是已注册），就尝试登录
                if (error) {
                    let login = await supabase.auth.signInWithPassword({ email: email, password: pwd });
                    if (login.error) {
                        msg.innerText = "错误: " + login.error.message;
                        return;
                    }
                    data = login.data;
                }

                if (data.session) {
                    showMain(data.user);
                } else {
                    msg.innerText = "注册成功，请再次点击进入。";
                }
            } catch (e) {
                alert("发生异常: " + e.message);
            }
        }

        async function showMain(user) {
            document.getElementById('auth-box').classList.add('hidden');
            document.getElementById('main-page').classList.remove('hidden');
            
            // 查云端余额
            const { data } = await supabase.from('profiles').select('*').eq('id', user.id).single();
            if (data) {
                document.getElementById('user-info').innerHTML = `
                    <p>你的名字: ${data.username}</p>
                    <p>你的UID: ${data.uid_display}</p>
                    <p style="font-size: 24px; color: gold;">余额: ${data.mist_coins} 币</p>
                `;
            } else {
                document.getElementById('user-info').innerText = "首次登录，正在为你生成初始余额...";
                location.reload(); // 简单处理：重新加载即可触发 profile 创建
            }
        }
    </script>
</body>
</html>
